<!DOCTYPE html>
<!-- D√©claration du type de document HTML5 -->
<html lang="fr">
<!-- Balise d'ouverture HTML, avec la langue du contenu d√©finie sur "fran√ßais" -->

<head>
    <!-- Section d'en-t√™te du document, contenant les m√©tadonn√©es et les liens -->
    <meta charset="UTF-8">
    <!-- D√©clare l'encodage des caract√®res du document comme √©tant UTF-8 -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Configure le viewport pour un affichage optimal sur les appareils mobiles -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Permet √† l'application web d'√™tre ajout√©e √† l'√©cran d'accueil sur iOS -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Style de la barre de statut sur iOS -->
    <meta name="apple-mobile-web-app-title" content="Warrior">
    <!-- Titre de l'application pour l'√©cran d'accueil iOS -->
    <meta name="theme-color" content="#0A0A0A">
    <!-- Couleur du th√®me pour la barre d'adresse du navigateur sur les mobiles -->
    <meta name="description" content="Suivi d'habitudes - Mentalit√© de champion">
    <!-- Description de l'application pour les moteurs de recherche -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Permet √† l'application web d'√™tre ajout√©e √† l'√©cran d'accueil sur Android -->

    <!-- LIENS EXTERNES ET INTERNES -->
    <link rel="manifest" href="manifest.json">
    <!-- Lien vers le fichier manifest pour la PWA (Progressive Web App) -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230A0A0A' width='100' height='100' rx='20'/><path d='M 23 74 Q 27 70 31 66 Q 39 58 47 54 Q 55 50 62 39 Q 68 29 74 19' fill='none' stroke='%23F5F5F0' stroke-width='6' stroke-linecap='round'/><path d='M 66 16 L 77 18 L 75 29' fill='none' stroke='%23F5F5F0' stroke-width='6' stroke-linecap='round'/></svg>">
    <!-- Favicon SVG int√©gr√© directement dans le HTML -->
    <link rel="apple-touch-icon" href="favicon.svg">
    <!-- Ic√¥ne pour l'√©cran d'accueil sur les appareils Apple -->
    <title>PROJET FEVRIER</title>
    <!-- Titre de la page qui s'affiche dans l'onglet du navigateur -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Inclusion de la biblioth√®que Chart.js pour les graphiques -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <!-- Inclusion des biblioth√®ques Firebase pour l'authentification et la base de donn√©es -->

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Page d'authentification (affich√©e si non connect√©) -->
    <div id="page-auth" class="page">
        <div class="auth-container">
            <div class="auth-logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <rect fill="#0A0A0A" width="100" height="100" rx="20" />
                    <path d="M 23 74 Q 27 70 31 66 Q 39 58 47 54 Q 55 50 62 39 Q 68 29 74 19" fill="none"
                        stroke="#F5F5F0" stroke-width="6" stroke-linecap="round" />
                    <path d="M 66 16 L 77 18 L 75 29" fill="none" stroke="#F5F5F0" stroke-width="6"
                        stroke-linecap="round" />
                </svg>
                <h1>PROJET FEVRIER</h1>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">CONNEXION</button>
                <button class="auth-tab" onclick="showAuthTab('signup')">INSCRIPTION</button>
            </div>

            <!-- Formulaire de connexion -->
            <div id="auth-login" class="auth-form active">
                <input type="email" id="login-email" placeholder="Email" autocomplete="email" required>
                <input type="password" id="login-password" placeholder="Mot de passe (min 8 caract√®res)"
                    autocomplete="current-password" required>
                <button class="auth-btn" onclick="handleLogin()">Se connecter</button>
                <div class="auth-error" id="login-error"></div>
                <a href="#" class="forgot-password-link" onclick="handleForgotPassword(); return false;">Mot de passe
                    oubli√© ?</a>
            </div>

            <!-- Formulaire d'inscription -->
            <div id="auth-signup" class="auth-form">
                <input type="email" id="signup-email" placeholder="Email" autocomplete="email" required>
                <input type="password" id="signup-password" placeholder="Mot de passe (min 8 caract√®res)"
                    autocomplete="new-password" required>
                <input type="password" id="signup-confirm" placeholder="Confirmer le mot de passe"
                    autocomplete="new-password" required>
                <button class="auth-btn" onclick="handleSignup()">S'inscrire</button>
                <div class="auth-error" id="signup-error"></div>
            </div>
        </div>
    </div>

    <!-- En-t√™te principal de l'application -->
    <div class="header">
        <h1>PROJET FEVRIER</h1>
        <div class="quote">TEXTE</div>
    </div>

    <!-- Page "Aujourd'hui" : affiche les habitudes du jour -->
    <div id="page-today" class="page active">
        <!-- Navigation pour changer de date -->
        <div class="date-nav">
            <button onclick="changeDate(-1)">‚óÄ</button>
            <div class="current-date" id="currentDate"></div>
            <button onclick="changeDate(1)">‚ñ∂</button>
        </div>

        <!-- Indicateurs cl√©s de performance (KPIs) -->
        <div class="kpi-container">
            <div class="kpi-card">
                <div class="label">Score</div>
                <div class="value" id="dailyScore">0%</div>
                <div class="sub">Aujourd'hui</div>
            </div>
            <div class="kpi-card">
                <div class="label">Streak</div>
                <div class="value" id="currentStreak">0</div>
                <div class="sub">Jours</div>
            </div>
            <div class="kpi-card">
                <div class="label">Perfect</div>
                <div class="value" id="perfectDays">0</div>
                <div class="sub">Jours 100%</div>
            </div>
        </div>

        <!-- Titre de la section des habitudes -->
        <div class="section-title">
            <span>üéØ MISSIONS DU JOUR</span>
            <span id="completedCount">0/10</span>
        </div>

        <!-- Liste des habitudes (g√©n√©r√©e par JavaScript) -->
        <div class="habits-list" id="habitsList"></div>

        <!-- Bouton pour valider la journ√©e -->
        <button id="validateDayBtn" class="validate-day-btn" onclick="showValidateDayModal()" style="display: none;">
            ‚úÖ VALIDER LA JOURN√âE
        </button>
    </div>

    <!-- Page "Stats" : affiche les statistiques et graphiques -->
    <div id="page-stats" class="page">
        <!-- Affichage du rang de l'utilisateur -->
        <div class="rank-display">
            <div class="rank-title">Ton Rang Actuel</div>
            <div class="rank-name" id="rankName">D√âBUTANT</div>
            <div class="rank-progress">
                <div class="rank-progress-bar" id="rankProgress" style="width: 0%"></div>
            </div>
        </div>

        <!-- Section des Badges -->
        <div id="badgesContainer"></div>

        <!-- Performance du mois -->
        <div class="section-title">‚è≥‚Äã CE MOIS-CI</div>
        <!-- Bouton calendrier visuel -->
        <div class="calendar-btn-container">
            <button class="calendar-view-btn" onclick="openCalendarModal()">
                üìÖ VOIR LE CALENDRIER DU MOIS
            </button>
        </div>

        <!-- Grille de performance de la semaine -->
        <div class="section-title">üìä CETTE SEMAINE</div>
        <div class="weekly-grid" id="weeklyGrid"></div>

        <!-- Section des graphiques de progression -->
        <div class="section-title">üìà PROGRESSION</div>
        <div class="chart-container">
            <div class="chart-wrapper">
                <div class="chart-title">Score des 7 derniers jours</div>
                <canvas id="weeklyChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <div class="chart-title">Performance par habitude</div>
                <canvas id="habitsChart"></canvas>
            </div>
        </div>

        <!-- Grille des statistiques g√©n√©rales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="monthScore">0%</div>
                <div class="stat-label">Score du mois</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestStreak">0</div>
                <div class="stat-label">Meilleure s√©rie</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalWins">0</div>
                <div class="stat-label">Victoires totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgScore">0%</div>
                <div class="stat-label">Moyenne globale</div>
            </div>
        </div>
    </div>

    <!-- Page "Motivation" : citations, r√®gles et informations -->
    <div id="page-motivation" class="page">
        <div class="section-title">üî• MENTAL</div>
        <div class="motivation-card">
            <div class="quote-text" id="dailyQuote">"I don't count my sit-ups. I only start counting when it hurts."
            </div>
            <div class="quote-author" id="quoteAuthor">- Muhammad Ali</div>
        </div>

        <!-- Syst√®me de rangs dans la page informations -->
        <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>üèÜRANG √Ä ATTEINDRE</span>
            <button id="editRanksBtn" class="edit-ranks-btn" onclick="toggleRankEditMode()">‚úèÔ∏è</button>
        </div>
        <div id="ranksContainer" style="padding: 15px;">
            <!-- G√©n√©r√© dynamiquement par JavaScript -->
        </div>
        <!-- Boutons d'√©dition (cach√©s par d√©faut) -->
        <div id="rankEditButtons" class="rank-edit-buttons" style="display: none; padding: 0 15px 15px; gap: 10px;">
            <button class="modal-btn cancel" onclick="cancelRankEdit()">Annuler</button>
            <button class="modal-btn save" onclick="saveRankSettings()">Enregistrer</button>
        </div>

        <!-- Section des param√®tres -->
        <div class="section-title">‚öôÔ∏è PARAM√àTRES</div>

        <div class="settings-container">
            <!-- Cat√©gorie : Habitudes -->
            <div class="settings-category">
                <div class="settings-category-header">
                    <span class="settings-category-icon">üìù</span>
                    <span class="settings-category-title">Habitudes</span>
                </div>
                <div class="settings-category-content">
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-label">Gestion des habitudes</div>
                            <div class="settings-item-desc">Ajouter, modifier ou supprimer</div>
                        </div>
                        <div class="settings-item-action">
                            <button class="settings-btn primary" onclick="openManageHabitsModal()">Modifier</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cat√©gorie : Apparence -->
            <div class="settings-category">
                <div class="settings-category-header">
                    <span class="settings-category-icon">üé®</span>
                    <span class="settings-category-title">Apparence</span>
                </div>
                <div class="settings-category-content">
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-label">Th√®me de l'application</div>
                            <div class="settings-item-desc">Clair ou sombre</div>
                        </div>
                        <div class="settings-item-action">
                            <button id="themeToggleBtn" class="settings-btn" onclick="toggleTheme()">
                                <span id="themeToggleIcon">üåô</span>
                                <span id="themeToggleText">Sombre</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cat√©gorie : Notifications -->
            <div class="settings-category">
                <div class="settings-category-header">
                    <span class="settings-category-icon">üîî</span>
                    <span class="settings-category-title">Notifications</span>
                </div>
                <div class="settings-category-content">
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-label">Heure de rappel</div>
                            <div class="settings-item-desc">Rappel quotidien</div>
                        </div>
                        <div class="settings-item-action">
                            <div class="time-input-wrapper">
                                <span class="time-icon">‚è∞</span>
                                <input type="time" id="notifTime" value="21:00" class="settings-time-input"
                                    onchange="updateNotificationTime()">
                            </div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-label">Activer les notifications</div>
                            <div class="settings-item-desc">Recevoir des rappels</div>
                        </div>
                        <div class="settings-item-action">
                            <button id="notifBtn" class="settings-btn" onclick="toggleNotifications()">OFF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cat√©gorie : Compte -->
            <div class="settings-category">
                <div class="settings-category-header">
                    <span class="settings-category-icon">üë§</span>
                    <span class="settings-category-title">Compte</span>
                </div>
                <div class="settings-category-content">
                    <div class="settings-item" id="logoutItem" style="display: none;">
                        <div class="settings-item-info">
                            <div class="settings-item-label">D√©connexion</div>
                            <div class="settings-item-desc">Se d√©connecter de l'application</div>
                        </div>
                        <div class="settings-item-action">
                            <button id="logoutBtn" class="settings-btn" onclick="handleLogout()">Sortir</button>
                        </div>
                    </div>
                    <div class="settings-item" id="deleteItem" style="display: none;">
                        <div class="settings-item-info">
                            <div class="settings-item-label">Supprimer le compte</div>
                            <div class="settings-item-desc">Action irr√©versible</div>
                        </div>
                        <div class="settings-item-action">
                            <button id="deleteAccountBtn" class="settings-btn danger"
                                onclick="handleDeleteAccount()">Supprimer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cat√©gorie : Aide -->
            <div class="settings-category">
                <div class="settings-category-header">
                    <span class="settings-category-icon">‚ùì</span>
                    <span class="settings-category-title">Aide</span>
                </div>
                <div class="settings-category-content">
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-label">Tutoriel</div>
                            <div class="settings-item-desc">Revoir le guide de d√©marrage</div>
                        </div>
                        <div class="settings-item-action">
                            <button class="settings-btn" onclick="restartTutorial()">Revoir</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cat√©gorie : Donn√©es -->
            <div class="settings-category">
                <div class="settings-category-header">
                    <span class="settings-category-icon">üíæ</span>
                    <span class="settings-category-title">Donn√©es</span>
                </div>
                <div class="settings-category-content">
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-label">R√©initialiser</div>
                            <div class="settings-item-desc">Effacer toutes les donn√©es</div>
                        </div>
                        <div class="settings-item-action">
                            <button class="settings-btn danger" onclick="resetAllData()">Effacer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fen√™tre modale pour la gestion compl√®te des habitudes -->
    <div class="modal-overlay" id="manageHabitsModal">
        <div class="modal modal-large">
            <h3>‚öôÔ∏è G√âRER LES HABITUDES</h3>

            <!-- Section pour ajouter une nouvelle habitude -->
            <div class="add-habit-section collapsed" id="addHabitSection">
                <button class="add-habit-toggle" onclick="toggleAddHabitForm()">
                    ‚ûï Ajouter une habitude
                </button>
                <div class="add-habit-form" id="addHabitForm">
                    <div class="form-group">
                        <label>Nom de l'habitude</label>
                        <input type="text" id="newHabitName" placeholder="Ex: M√âDITATION" maxlength="50">
                    </div>

                    <div class="form-group">
                        <label>Description <span class="optional-label">(optionnel)</span></label>
                        <textarea id="newHabitDescription" placeholder="Ex: 10 minutes de m√©ditation chaque matin" maxlength="150" rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Ic√¥ne</label>
                        <div class="icon-picker" id="iconPicker">
                            <!-- Ic√¥nes populaires pour habitudes -->
                            <div class="icon-option" data-icon="üßò">üßò</div>
                            <div class="icon-option" data-icon="üèÉ">üèÉ</div>
                            <div class="icon-option" data-icon="üí™">üí™</div>
                            <div class="icon-option" data-icon="üéµ">üéµ</div>
                            <div class="icon-option" data-icon="üìñ">üìñ</div>
                            <div class="icon-option" data-icon="‚úçÔ∏è">‚úçÔ∏è</div>
                            <div class="icon-option" data-icon="üé®">üé®</div>
                            <div class="icon-option" data-icon="üß†">üß†</div>
                            <div class="icon-option" data-icon="‚ù§Ô∏è">‚ù§Ô∏è</div>
                            <div class="icon-option" data-icon="üå±">üå±</div>
                            <div class="icon-option" data-icon="‚òÄÔ∏è">‚òÄÔ∏è</div>
                            <div class="icon-option" data-icon="üåô">üåô</div>
                            <div class="icon-option" data-icon="‚≠ê">‚≠ê</div>
                            <div class="icon-option" data-icon="üíé">üíé</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Couleur</label>
                        <div class="color-picker-grid" id="colorPicker">
                            <div class="color-option" data-color="#F5F5F0" style="background: #F5F5F0;"></div>
                            <div class="color-option" data-color="#87CEEB" style="background: #87CEEB;"></div>
                            <div class="color-option" data-color="#90EE90" style="background: #90EE90;"></div>
                            <div class="color-option" data-color="#FFD700" style="background: #FFD700;"></div>
                            <div class="color-option" data-color="#FF6B6B" style="background: #FF6B6B;"></div>
                            <div class="color-option" data-color="#9370DB" style="background: #9370DB;"></div>
                            <div class="color-option" data-color="#FF69B4" style="background: #FF69B4;"></div>
                            <div class="color-option" data-color="#FFA500" style="background: #FFA500;"></div>
                            <div class="color-option" data-color="#4682B4" style="background: #4682B4;"></div>
                            <div class="color-option" data-color="#32CD32" style="background: #32CD32;"></div>
                            <div class="color-option" data-color="#FF4500" style="background: #FF4500;"></div>
                            <div class="color-option" data-color="#8B4513" style="background: #8B4513;"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Fr√©quence</label>
                        <div class="schedule-type-picker" id="scheduleTypePicker">
                            <button type="button" class="schedule-type-btn active" data-type="daily" onclick="setScheduleType('daily')">
                                üìÖ Tous les jours
                            </button>
                            <button type="button" class="schedule-type-btn" data-type="weekly" onclick="setScheduleType('weekly')">
                                üìÜ Certains jours
                            </button>
                        </div>
                        <div class="days-of-week-picker" id="daysOfWeekPicker" style="display: none;">
                            <div class="day-checkbox" data-day="1" onclick="toggleDayOfWeek(1)">L</div>
                            <div class="day-checkbox" data-day="2" onclick="toggleDayOfWeek(2)">M</div>
                            <div class="day-checkbox" data-day="3" onclick="toggleDayOfWeek(3)">M</div>
                            <div class="day-checkbox" data-day="4" onclick="toggleDayOfWeek(4)">J</div>
                            <div class="day-checkbox" data-day="5" onclick="toggleDayOfWeek(5)">V</div>
                            <div class="day-checkbox" data-day="6" onclick="toggleDayOfWeek(6)">S</div>
                            <div class="day-checkbox" data-day="0" onclick="toggleDayOfWeek(0)">D</div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="form-btn cancel" onclick="cancelAddHabit()">Annuler</button>
                        <button class="form-btn save" onclick="saveNewHabit()">Ajouter</button>
                    </div>
                </div>
            </div>

            <!-- Liste des habitudes existantes -->
            <div class="habits-management-list" id="habitsManagementList">
                <!-- Rempli dynamiquement par JavaScript -->
            </div>

            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeManageHabitsModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal de migration localStorage ‚Üí Firestore -->
    <div class="modal-overlay" id="migrationModal">
        <div class="modal">
            <h3>üîÑ MIGRATION DES DONN√âES</h3>
            <p style="color: var(--accent-dim); text-align: center; margin-bottom: 15px;">
                Nous avons d√©tect√© des donn√©es existantes sur cet appareil.<br>
                Veux-tu les transf√©rer vers ton nouveau compte ?
            </p>
            <div class="migration-preview" id="migrationPreview">
                <!-- Aper√ßu des donn√©es √† migrer (rempli dynamiquement) -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="skipMigration()">Ignorer</button>
                <button class="modal-btn save" onclick="performMigration()">Migrer</button>
            </div>
        </div>
    </div>

    <!-- Modal de validation de journ√©e -->
    <div class="modal-overlay" id="validateDayModal">
        <div class="modal">
            <h3>‚úÖ VALIDER LA JOURN√âE</h3>
            <p style="color: var(--accent); text-align: center; margin: 20px 0; font-size: 1.1rem;">
                Es-tu s√ªr de vouloir valider ta journ√©e ?
            </p>
            <p style="color: var(--accent-dim); text-align: center; margin-bottom: 20px; font-size: 0.9rem;">
                Une fois valid√©e, tu ne pourras plus modifier tes habitudes d'aujourd'hui.
            </p>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="modal-btn cancel" onclick="closeValidateDayModal()">Annuler</button>
                <button class="modal-btn save" onclick="confirmValidateDay()">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modal de d√©connexion -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal">
            <h3>üö™ D√âCONNEXION</h3>
            <p style="color: var(--accent); text-align: center; margin: 20px 0; font-size: 1.1rem;">
                Veux-tu vraiment te d√©connecter ?
            </p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeLogoutModal()">Annuler</button>
                <button class="modal-btn save" onclick="confirmLogout()">D√©connecter</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation g√©n√©rique -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <h3 id="confirmModalTitle">Confirmation</h3>
            <p id="confirmModalMessage"
                style="color: var(--accent); text-align: center; margin: 20px 0; font-size: 1rem; line-height: 1.5;">
            </p>
            <p id="confirmModalSubtext"
                style="color: var(--accent-dim); text-align: center; margin-bottom: 20px; font-size: 0.85rem; display: none;">
            </p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="confirmModalCancel">Annuler</button>
                <button class="modal-btn save" id="confirmModalConfirm">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modal de suppression de compte -->
    <div class="modal-overlay" id="deleteAccountModal">
        <div class="modal">
            <h3>‚ö†Ô∏è SUPPRIMER MON COMPTE</h3>
            <p style="color: #FF6B6B; text-align: center; margin: 15px 0; font-size: 1rem; font-weight: bold;">
                Cette action est IRR√âVERSIBLE !
            </p>
            <div style="background: var(--dark-gray); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="color: var(--accent-dim); font-size: 0.85rem; text-align: left; margin-bottom: 10px;">
                    Toutes tes donn√©es seront <strong>d√©finitivement supprim√©es,</strong> ton historique sera effac√© et
                    tes habitudes enregistr√©es seront <strong>PERDUES.</strong>
                </p>
            </div>
            <p style="color: var(--accent); text-align: center; margin-bottom: 10px; font-size: 0.9rem;">
                Tape <strong>SUPPRIMER</strong> pour confirmer :
            </p>
            <input type="text" id="deleteAccountInput" placeholder="SUPPRIMER"
                style="width: 100%; padding: 12px; background: var(--charcoal); border: 1px solid var(--steel); border-radius: 8px; color: var(--accent); font-size: 1rem; text-align: center; margin-bottom: 20px;">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeDeleteAccountModal()">Annuler</button>
                <button class="modal-btn save" style="background: #8B0000; color: #FFE5E5;"
                    onclick="confirmDeleteAccount()">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- MODAL CALENDRIER VISUEL - IMPACT PSYCHOLOGIQUE -->
    <!-- ============================================================ -->
    <div class="modal-overlay" id="calendarModal">
        <div class="modal modal-calendar">
            <div class="calendar-header">
                <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">‚óÄ</button>
                <h3 id="calendarTitle">üìÖ JANVIER 2025</h3>
                <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">‚ñ∂</button>
            </div>
            <p class="calendar-subtitle">Visualise tes victoires et tes √©checs d'un seul regard</p>

            <!-- L√©gende -->
            <div class="calendar-legend">
                <div class="legend-item">
                    <span class="legend-box legend-success"></span>
                    <span>Fait</span>
                </div>
                <div class="legend-item">
                    <span class="legend-box legend-fail"></span>
                    <span>Non fait</span>
                </div>
                <div class="legend-item">
                    <span class="legend-box legend-future"></span>
                    <span>√Ä venir</span>
                </div>
            </div>

            <!-- Calendrier g√©n√©r√© dynamiquement -->
            <div class="calendar-grid-container" id="calendarGridContainer">
                <!-- Rempli par JavaScript -->
            </div>

            <!-- R√©sum√© du mois -->
            <div class="calendar-summary" id="calendarSummary">
                <!-- Rempli par JavaScript -->
            </div>

            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeCalendarModal()" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- TUTORIEL ONBOARDING - WARRIOR EXPERIENCE -->
    <!-- ============================================================ -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <!-- Particules d'arri√®re-plan -->
        <div class="tutorial-particles" id="tutorialParticles"></div>

        <!-- Conteneur principal du tutoriel -->
        <div class="tutorial-container" id="tutorialContainer">

            <!-- √âTAPE 1 : BIENVENUE √âPIQUE -->
            <div class="tutorial-step active" data-step="1">
                <div class="tutorial-icon-large animate-float">‚öîÔ∏è</div>
                <h1 class="tutorial-title glitch" data-text="BIENVENUE, GUERRIER">BIENVENUE</h1>
                <div class="tutorial-subtitle typewriter">Tu viens de rejoindre un groupe tr√®s ferm√©...</div>
                <div class="tutorial-content">
                    <p class="tutorial-text fade-in-delay">
                        <strong>PROJET FEVRIER</strong> n'est pas une simple application.<br>
                        C'est un <span class="highlight">Syst√®me</span> con√ßu pour forger ta discipline et atteindre tes
                        objectifs.
                    </p>
                    <div class="warrior-quote">
                        <span class="quote-icon">üî•</span>
                        "Nos actions quotidiennes d√©terminent √† quoi ressemblera notre futur"
                    </div>
                </div>
                <div class="tutorial-cta">
                    <button class="tutorial-btn primary pulse-btn" onclick="nextTutorialStep()">
                        COMMENCER
                        <span class="btn-arrow">‚Üí</span>
                    </button>
                </div>
            </div>

            <!-- √âTAPE 2 : TES MISSIONS -->
            <div class="tutorial-step" data-step="2">
                <div class="tutorial-icon-large">üéØ</div>
                <h2 class="tutorial-title">TES MISSIONS QUOTIDIENNES</h2>
                <div class="tutorial-subtitle">Des habitudes pour √™tre toujours 1% meilleur que hier</div>
                <div class="tutorial-content">
                    <div class="habits-showcase">
                        <div class="habit-preview" style="--delay: 0.1s">
                            <span class="habit-icon">üßä</span>
                            <span class="habit-label">HABITUDE 1</span>
                        </div>
                        <div class="habit-preview" style="--delay: 0.2s">
                            <span class="habit-icon">üìö</span>
                            <span class="habit-label">HABITUDE 2</span>
                        </div>
                        <div class="habit-preview" style="--delay: 0.3s">
                            <span class="habit-icon">ü•ó</span>
                            <span class="habit-label">HABITUDE 3</span>
                        </div>
                        <div class="habit-preview" style="--delay: 0.4s">
                            <span class="habit-icon">üò¥</span>
                            <span class="habit-label">HABITUDE 4</span>
                        </div>
                        <div class="habit-preview" style="--delay: 0.5s">
                            <span class="habit-icon">üíß</span>
                            <span class="habit-label">HABITUDE 5</span>
                        </div>
                        <div class="habit-preview" style="--delay: 0.6s">
                            <span class="habit-icon">‚è∞</span>
                            <span class="habit-label">HABITUDE 6</span>
                        </div>
                    </div>
                    <p class="tutorial-note">
                        üí° Tu pourras <strong>personnaliser</strong>, <strong>ajouter</strong> ou
                        <strong>supprimer</strong> des habitudes selon tes objectifs !
                    </p>
                </div>
                <div class="tutorial-nav-buttons">
                    <button class="tutorial-btn primary" onclick="nextTutorialStep()">
                        CONTINUER <span class="btn-arrow">‚Üí</span>
                    </button>
                </div>
            </div>

            <!-- √âTAPE 3 : CR√âER UNE HABITUDE -->
            <div class="tutorial-step" data-step="3">
                <div class="tutorial-icon-large">‚ú®</div>
                <h2 class="tutorial-title">CR√âE TA PROPRE HABITUDE</h2>
                <div class="tutorial-subtitle">Personnalise ton parcours et vise les sommets</div>
                <div class="tutorial-content">
                    <div class="demo-create-habit">
                        <div class="demo-step">
                            <div class="demo-number">1</div>
                            <div class="demo-content">
                                <div class="demo-label">Donne un nom</div>
                                <div class="demo-input-fake">30 MIN DE LECTURE</div>
                            </div>
                        </div>
                        <div class="demo-step">
                            <div class="demo-number">2</div>
                            <div class="demo-content">
                                <div class="demo-label">Choisis ton ic√¥ne</div>
                                <div class="demo-icons">
                                    <span class="demo-icon">üßò</span>
                                    <span class="demo-icon selected">üß†</span>
                                    <span class="demo-icon">üí™</span>
                                    <span class="demo-icon">üî•</span>
                                </div>
                            </div>
                        </div>
                        <div class="demo-step">
                            <div class="demo-number">3</div>
                            <div class="demo-content">
                                <div class="demo-label">S√©lectionne ta couleur</div>
                                <div class="demo-colors">
                                    <span class="demo-color" style="background: #F5F5F0"></span>
                                    <span class="demo-color selected" style="background: #87CEEB"></span>
                                    <span class="demo-color" style="background: #90EE90"></span>
                                    <span class="demo-color" style="background: #FFD700"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="demo-result">
                        <div class="demo-result-label">R√âSULTAT</div>
                        <div class="demo-habit-card">
                            <span class="demo-habit-icon" style="color: #87CEEB">üß†</span>
                            <span class="demo-habit-name">30 MIN DE LECTURE</span>
                        </div>
                    </div>
                </div>
                <div class="tutorial-nav-buttons">
                    <button class="tutorial-btn primary" onclick="nextTutorialStep()">
                        CONTINUER <span class="btn-arrow">‚Üí</span>
                    </button>
                </div>
            </div>

            <!-- √âTAPE 4 : VALIDER UNE HABITUDE -->
            <div class="tutorial-step" data-step="4">
                <div class="tutorial-icon-large">‚úÖ</div>
                <h2 class="tutorial-title">VALIDE TES VICTOIRES</h2>
                <div class="tutorial-subtitle">Chaque case coch√©e est une bataille gagn√©e</div>
                <div class="tutorial-content">
                    <div class="demo-validation">
                        <div class="demo-habit-item" id="demoHabitItem">
                            <div class="demo-checkbox" id="demoCheckbox" onclick="toggleDemoCheckbox()"></div>
                            <div class="demo-habit-info">
                                <div class="demo-habit-title">üß† 30 MIN DE LECTURE</div>
                                <div class="demo-habit-streak">üî• S√©rie: 0 jours</div>
                            </div>
                            <div class="demo-percent">0%</div>
                        </div>
                        <div class="demo-instruction" id="demoInstruction">
                            <span class="tap-icon">üëÜ</span> Clique ici !
                        </div>
                        <div class="demo-success" id="demoSuccess">
                            <span class="success-icon">üéâ</span> VICTOIRE ! Continue comme √ßa !
                        </div>
                    </div>
                    <div class="validation-tips">
                        <div class="tip-item">
                            <span class="tip-icon">‚ö°</span>
                            <span>Valide tes habitudes au fur et √† mesure de la journ√©e</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">üîí</span>
                            <span>Une fois la journ√©e valid√©e, elle est verrouill√©e</span>
                        </div>
                    </div>
                </div>
                <div class="tutorial-nav-buttons">
                    <button class="tutorial-btn primary" onclick="nextTutorialStep()">
                        CONTINUER <span class="btn-arrow">‚Üí</span>
                    </button>
                </div>
            </div>

            <!-- √âTAPE 5 : LES R√àGLES DU JEU -->
            <div class="tutorial-step" data-step="5">
                <div class="tutorial-icon-large">üèÜ</div>
                <h2 class="tutorial-title">LES R√àGLES DU JEU</h2>
                <div class="tutorial-subtitle">Comprends le syst√®me pour devenir M-E-I-L-L-E-U-R</div>
                <div class="tutorial-content">
                    <div class="rules-grid">
                        <div class="rule-card" style="--delay: 0.1s">
                            <div class="rule-icon">üìä</div>
                            <div class="rule-title">SCORE QUOTIDIEN</div>
                            <div class="rule-desc">Chaque habitude valid√©e augmente ton score du jour</div>
                            <div class="rule-example">6/6 habitudes = <strong>100%</strong></div>
                        </div>
                        <div class="rule-card" style="--delay: 0.2s">
                            <div class="rule-icon">üî•</div>
                            <div class="rule-title">STREAK</div>
                            <div class="rule-desc">Nombre de jours cons√©cutifs avec un score ‚â• 70%</div>
                            <div class="rule-example">Ne brise jamais la cha√Æne !</div>
                        </div>
                        <div class="rule-card" style="--delay: 0.3s">
                            <div class="rule-icon">‚≠ê</div>
                            <div class="rule-title">JOURS PARFAITS</div>
                            <div class="rule-desc">Compte tes jours √† 100% d'accomplissement</div>
                            <div class="rule-example">Pour que l'excellence devienne une habitude</div>
                        </div>
                        <div class="rule-card" style="--delay: 0.4s">
                            <div class="rule-icon">üéñÔ∏è</div>
                            <div class="rule-title">SYST√àME DE RANG</div>
                            <div class="rule-desc">√âvolue selon ta moyenne globale</div>
                            <div class="rule-ranks">
                                <span class="rank debutant">D√âBUTANT</span>
                                <span class="rank-arrow">‚Üí</span>
                                <span class="rank apprenti">APPRENTI</span>
                                <span class="rank-arrow">‚Üí</span>
                                <span class="rank confirme">CONFIRM√â</span>
                                <span class="rank-arrow">‚Üí</span>
                                <span class="rank expert">EXPERT</span>
                                <span class="rank-arrow">‚Üí</span>
                                <span class="rank maitre">MA√éTRE</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tutorial-nav-buttons">
                    </button>
                    <button class="tutorial-btn primary" onclick="nextTutorialStep()">
                        CONTINUER <span class="btn-arrow">‚Üí</span>
                    </button>
                </div>
            </div>

            <!-- √âTAPE 6 : C'EST PARTI ! -->
            <div class="tutorial-step" data-step="6">
                <div class="tutorial-icon-large animate-bounce">üöÄ</div>
                <h2 class="tutorial-title glitch" data-text="TU ES PR√äT !">TU ES PR√äT ?</h2>
                <div class="tutorial-subtitle">Ta transformation commence aujourd'hui</div>
                <div class="tutorial-content">
                    <div class="final-message">
                        <div class="final-quote">
                            "La discipline est le pont entre les objectifs et l'accomplissement"
                            <span class="quote-author">- Jim Rohn</span>
                        </div>
                        <div class="final-stats">
                            <div class="final-stat">
                                <span class="stat-number">‚àû</span>
                                <span class="stat-label">Habitudes √† conqu√©rir</span>
                            </div>
                            <div class="final-stat">
                                <span class="stat-number">1</span>
                                <span class="stat-label">Personne qui peut les valider</span>
                            </div>
                            <div class="final-stat">
                                <span class="stat-number">24h</span>
                                <span class="stat-label">Pour les r√©ussir</span>
                            </div>
                        </div>
                    </div>
                    <div class="create-account-prompt">
                        <p>üì± <strong>Cr√©e ton compte</strong> pour sauvegarder ta progression et synchroniser tes
                            donn√©es sur tous tes appareils !</p>
                    </div>
                </div>
                <div class="tutorial-nav-buttons">
                    </button>
                    <button class="tutorial-btn primary cta-final" onclick="completeTutorial()">
                        DEVENIR MEILLEUR <span class="btn-arrow">‚öîÔ∏è</span>
                    </button>
                </div>
            </div>

            <!-- Indicateur de progression -->
            <div class="tutorial-progress">
                <div class="progress-dots">
                    <span class="progress-dot active" data-step="1"></span>
                    <span class="progress-dot" data-step="2"></span>
                    <span class="progress-dot" data-step="3"></span>
                    <span class="progress-dot" data-step="4"></span>
                    <span class="progress-dot" data-step="5"></span>
                    <span class="progress-dot" data-step="6"></span>
                </div>
                <div class="progress-text">
                    √âtape <span id="currentStepNum">1</span> sur 6
                </div>
            </div>

            <!-- Bouton skip -->
            <button class="tutorial-skip" onclick="skipTutorial()">
                Passer
            </button>
        </div>
    </div>

    <!-- Barre de navigation inf√©rieure fixe -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('today', event)">
            <div class="icon">‚öîÔ∏è</div>
            <div class="label">Habitudes</div>
        </div>
        <div class="nav-item" onclick="showPage('stats', event)">
            <div class="icon">üìä</div>
            <div class="label">Stats</div>
        </div>
        <div class="nav-item" onclick="showPage('motivation', event)">
            <div class="icon">üî•</div>
            <div class="label">Informations</div>
        </div>
    </div>

    <!-- SCRIPT JAVASCRIPT -->
    <script>
        // --- CONFIGURATION INITIALE ---

        // ============================================================
        // FIREBASE CONFIGURATION
        // ============================================================
        // IMPORTANT : Remplacez ces valeurs par votre propre configuration Firebase
        // Obtenez ces valeurs depuis Firebase Console > Project Settings > Your Apps
        const firebaseConfig = {
            apiKey: "AIzaSyAS0RofOjkTjaDjYhlLc1wISqCgozDOjNY",
            authDomain: "warrior-habit-tracker.firebaseapp.com",
            projectId: "warrior-habit-tracker",
            storageBucket: "warrior-habit-tracker.firebasestorage.app",
            messagingSenderId: "986537173596",
            appId: "1:986537173596:web:1ba2b4ec5e8991def47c99"
        };

        // Initialiser Firebase uniquement si la config est valide
        let auth, db;
        const isFirebaseConfigured = firebaseConfig.apiKey !== "VOTRE_API_KEY";

        if (isFirebaseConfigured && typeof firebase !== 'undefined') {
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                // Activer la persistance offline
                db.enablePersistence()
                    .catch((err) => {
                        console.warn('Persistance offline non disponible:', err);
                    });

                console.log('‚úÖ Firebase initialis√© avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur initialisation Firebase:', error);
            }
        } else {
            console.warn('‚ö†Ô∏è Firebase non configur√© - mode localStorage uniquement');
        }

        // State Management Global
        const appState = {
            currentUser: null,
            isOnline: navigator.onLine,
            isFirebaseMode: isFirebaseConfigured
        };

        // Donn√©es initiales des habitudes (vide - l'utilisateur doit cr√©er ses propres habitudes)
        const habits = [];

        // Collection de citations de motivation
        const quotes = [
            { text: "Je ne compte pas mes abdos. Je commence √† compter seulement quand √ßa fait mal.", author: "Muhammad Ali" },
            { text: "La douleur que tu ressens aujourd'hui sera la force que tu ressentiras demain.", author: "Arnold Schwarzenegger" },
            { text: "Je ne suis pas le plus talentueux, ni le plus dou√©... mais personne ne travaillera plus dur que moi.", author: "Cristiano Ronaldo" },
            { text: "Qui va porter les bateaux ?!", author: "David Goggins" },
            { text: "Souffre maintenant et vis le reste de ta vie comme un champion.", author: "Muhammad Ali" },
            { text: "Quand tu penses avoir termin√©, tu n'es qu'√† 40% de ta capacit√©.", author: "David Goggins" },
            { text: "La seule personne que tu es destin√© √† devenir est celle que tu d√©cides d'√™tre.", author: "Ralph Waldo Emerson" },
            { text: "Le travail acharn√© bat le talent quand le talent ne travaille pas dur.", author: "Tim Notke" }
        ];

        // ============================================================
        // SYST√àME DE RANGS PERSONNALISABLES
        // ============================================================

        // Structure de donn√©es globale pour les rangs (source de v√©rit√© unique)
        let rankSettings = [];
        let isRankEditMode = false;
        let rankSettingsBackup = []; // Pour annuler les modifications
        let selectedPaletteId = 'samourai'; // Palette par d√©faut
        let selectedPaletteIdBackup = 'samourai'; // Pour annuler

        // Les 7 palettes de couleurs pr√©d√©finies
        const colorPalettes = [
            {
                id: 'monochrome',
                name: 'Th√®me Principal',
                colors: ['#4A4A45', '#6A6A65', '#9A9A95', '#C5C5C0', '#F5F5F0']
            },
            {
                id: 'or-bronze',
                name: 'Or & Bronze',
                colors: ['#8B5A2B', '#CD853F', '#C0C0C0', '#DAA520', '#FFD700']
            },
            {
                id: 'feu-glace',
                name: 'Feu & Glace',
                colors: ['#5B7C99', '#48D1CC', '#BFFF00', '#FF6B35', '#FF2D2D']
            },
            {
                id: 'neon',
                name: 'N√©on Cyberpunk',
                colors: ['#5C4B8A', '#00D4FF', '#39FF14', '#FFFF00', '#FF00FF']
            },
            {
                id: 'nature',
                name: 'Nature & Terre',
                colors: ['#6B4423', '#8B9A6B', '#228B22', '#87CEEB', '#FFB347']
            },
            {
                id: 'pastel',
                name: 'Minimaliste Pastel',
                colors: ['#A8D8EA', '#AA96DA', '#FCBAD3', '#FF9AA2', '#FFDAC1']
            },
            {
                id: 'samourai',
                name: 'Guerrier Samoura√Ø',
                colors: ['#2C2C2C', '#4B5D67', '#8B0000', '#D4AF37', '#FFFAF0']
            }
        ];

        // Charge les rangs par d√©faut avec la palette Samoura√Ø
        function loadDefaultRanks() {
            const palette = colorPalettes.find(p => p.id === selectedPaletteId) || colorPalettes[6];
            return [
                { id: 'debutant', name: 'D√âBUTANT', minScore: 0, color: palette.colors[0] },
                { id: 'apprenti', name: 'APPRENTI', minScore: 31, color: palette.colors[1] },
                { id: 'confirme', name: 'CONFIRM√â', minScore: 51, color: palette.colors[2] },
                { id: 'expert', name: 'EXPERT', minScore: 71, color: palette.colors[3] },
                { id: 'maitre', name: 'MA√éTRE', minScore: 86, color: palette.colors[4], isTop: true }
            ];
        }

        // Applique une palette de couleurs aux rangs
        function applyPaletteToRanks(paletteId) {
            const palette = colorPalettes.find(p => p.id === paletteId);
            if (!palette) return;

            selectedPaletteId = paletteId;
            rankSettings.forEach((rank, index) => {
                if (index < palette.colors.length) {
                    rank.color = palette.colors[index];
                }
            });
        }

        // Charge les param√®tres de rangs depuis le stockage
        function loadRankSettings() {
            const data = getData();
            if (data.rankSettings && Array.isArray(data.rankSettings) && data.rankSettings.length > 0) {
                rankSettings = data.rankSettings;
                selectedPaletteId = data.selectedPaletteId || 'samourai';
                console.log('‚úÖ Rangs personnalis√©s charg√©s:', rankSettings.length);
            } else {
                rankSettings = loadDefaultRanks();
                console.log('üìã Rangs par d√©faut charg√©s');
            }
            // Trier par minScore croissant
            rankSettings.sort((a, b) => a.minScore - b.minScore);
        }

        // Sauvegarde les param√®tres de rangs
        function saveRankSettingsToStorage() {
            const data = getData();
            data.rankSettings = rankSettings;
            data.selectedPaletteId = selectedPaletteId;
            saveData(data);
            console.log('üíæ Rangs sauvegard√©s');
        }

        // Calcule la plage de score pour un rang donn√©
        function getRankScoreRange(index) {
            const rank = rankSettings[index];
            const nextRank = rankSettings[index + 1];
            const minScore = rank.minScore;
            const maxScore = nextRank ? nextRank.minScore - 1 : 100;
            return { min: minScore, max: maxScore };
        }

        // G√©n√®re l'aper√ßu d'une palette
        function renderPalettePreview(palette) {
            return palette.colors.map(color =>
                `<span class="palette-color-dot" style="background: ${color};"></span>`
            ).join('');
        }

        // Rendu dynamique de la liste des rangs
        function renderRanks(isEditing = false) {
            const container = document.getElementById('ranksContainer');
            if (!container) return;

            if (rankSettings.length === 0) {
                loadRankSettings();
            }

            let html = '';

            // En mode √©dition, ajouter le s√©lecteur de palette
            if (isEditing) {
                html += `
                    <div class="palette-selector">
                        <div class="palette-selector-header">
                            <span class="palette-icon">üé®</span>
                            <span class="palette-label">PALETTE DE COULEURS</span>
                        </div>
                        <div class="palette-grid" id="paletteGrid">
                            ${colorPalettes.map(palette => `
                                <div class="palette-card ${palette.id === selectedPaletteId ? 'selected' : ''}"
                                     onclick="onPaletteChange('${palette.id}')"
                                     data-palette-id="${palette.id}">
                                    <div class="palette-card-colors">
                                        ${palette.colors.map(color => `
                                            <span class="palette-card-dot" style="background: ${color};"></span>
                                        `).join('')}
                                    </div>
                                    <div class="palette-card-name">${palette.name}</div>
                                    ${palette.id === 'samourai' ? '<span class="palette-recommended">‚òÖ</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            rankSettings.forEach((rank, index) => {
                const range = getRankScoreRange(index);
                const isTopRank = rank.isTop || index === rankSettings.length - 1;

                if (isEditing) {
                    // Mode √©dition : nom modifiable, seuil de score fixe
                    html += `
                        <div class="stat-card rank-edit-card" style="margin-bottom: 10px; border-color: ${rank.color};">
                            <div class="rank-edit-row">
                                <span class="rank-color-preview" style="background: ${rank.color};"></span>
                                <input type="text"
                                    class="rank-name-input"
                                    value="${rank.name}"
                                    data-rank-id="${rank.id}"
                                    data-field="name"
                                    placeholder="Nom du rang"
                                    style="color: ${rank.color}; border-color: ${rank.color};">
                                <div class="rank-score-fixed" style="color: ${rank.color};">
                                    ${range.min}-${range.max}%
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Mode affichage normal
                    const bgStyle = isTopRank ? `background: ${rank.color};` : '';
                    const textColor = isTopRank ? 'var(--black)' : rank.color;

                    html += `
                        <div class="stat-card" style="margin-bottom: 10px; border-color: ${rank.color}; ${bgStyle}">
                            <div style="color: ${textColor}; font-weight: bold;">${rank.name}</div>
                            <div style="color: ${textColor}; font-size: 0.7rem;">${range.min}-${range.max}%</div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        // G√®re le changement de palette
        function onPaletteChange(paletteId) {
            applyPaletteToRanks(paletteId);

            // Mettre √† jour la s√©lection visuelle des cartes
            document.querySelectorAll('.palette-card').forEach(card => {
                if (card.dataset.paletteId === paletteId) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            // Re-render pour mettre √† jour les couleurs des inputs
            renderRanks(true);

            // Feedback
            if (navigator.vibrate) navigator.vibrate(20);
        }

        // Active/d√©sactive le mode √©dition des rangs
        function toggleRankEditMode() {
            isRankEditMode = !isRankEditMode;

            const editBtn = document.getElementById('editRanksBtn');
            const editButtons = document.getElementById('rankEditButtons');

            if (isRankEditMode) {
                // Sauvegarder l'√©tat actuel pour pouvoir annuler
                rankSettingsBackup = JSON.parse(JSON.stringify(rankSettings));
                selectedPaletteIdBackup = selectedPaletteId;
                editBtn.textContent = 'üîí';
                editBtn.title = 'Mode √©dition actif';
                editButtons.style.display = 'flex';
                renderRanks(true);
            } else {
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.title = 'Modifier les rangs';
                editButtons.style.display = 'none';
                renderRanks(false);
            }
        }

        // Annule l'√©dition des rangs
        function cancelRankEdit() {
            // Restaurer les valeurs sauvegard√©es
            rankSettings = JSON.parse(JSON.stringify(rankSettingsBackup));
            selectedPaletteId = selectedPaletteIdBackup;
            isRankEditMode = false;

            const editBtn = document.getElementById('editRanksBtn');
            const editButtons = document.getElementById('rankEditButtons');

            editBtn.textContent = '‚úèÔ∏è';
            editButtons.style.display = 'none';
            renderRanks(false);

            showPopup('Modifications annul√©es', 'info');
        }

        // Sauvegarde les param√®tres de rangs depuis les inputs
        function saveRankSettings() {
            // R√©cup√©rer uniquement les noms (les scores sont fixes)
            const nameInputs = document.querySelectorAll('.rank-name-input');

            let hasError = false;

            // R√©cup√©rer la palette s√©lectionn√©e
            const palette = colorPalettes.find(p => p.id === selectedPaletteId);

            nameInputs.forEach((input, index) => {
                const name = input.value.trim().toUpperCase();

                if (!name) {
                    showPopup(`Le nom du rang ${index + 1} est requis`, 'warning');
                    hasError = true;
                    return;
                }

                // Mettre √† jour uniquement le nom et la couleur (le score reste fixe)
                rankSettings[index].name = name;
                rankSettings[index].color = palette ? palette.colors[index] : rankSettings[index].color;
            });

            if (hasError) return;

            // Marquer le dernier comme isTop
            if (rankSettings.length > 0) {
                rankSettings.forEach((r, i) => r.isTop = (i === rankSettings.length - 1));
            }

            // Sauvegarder
            saveRankSettingsToStorage();

            // Sortir du mode √©dition
            isRankEditMode = false;
            const editBtn = document.getElementById('editRanksBtn');
            const editButtons = document.getElementById('rankEditButtons');

            editBtn.textContent = '‚úèÔ∏è';
            editButtons.style.display = 'none';
            renderRanks(false);

            // Mettre √† jour l'affichage du rang utilisateur
            updateStats();

            if (navigator.vibrate) navigator.vibrate([30, 30, 30]);
            showPopup('Rangs personnalis√©s sauvegard√©s !', 'success');
        }

        // R√©initialiser les rangs par d√©faut
        async function resetRanksToDefault() {
            const confirmed = await ConfirmModal.show({
                title: 'üîÑ R√âINITIALISER LES RANGS',
                message: 'Remettre les rangs par d√©faut ?',
                confirmText: 'R√©initialiser',
                cancelText: 'Annuler'
            });

            if (confirmed) {
                rankSettings = loadDefaultRanks();
                saveRankSettingsToStorage();
                renderRanks(false);
                updateStats();
                showPopup('Rangs r√©initialis√©s', 'success');
            }
        }

        // ============================================================
        // SYST√àME DE POPUP/TOAST NOTIFICATIONS
        // ============================================================

        const ToastManager = {
            container: null,

            init() {
                if (this.container) return;
                this.container = document.createElement('div');
                this.container.className = 'toast-container';
                this.container.setAttribute('role', 'alert');
                this.container.setAttribute('aria-live', 'polite');
                this.container.setAttribute('aria-atomic', 'true');
                document.body.appendChild(this.container);
            },

            getIcon(type) {
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                return icons[type] || icons.info;
            },

            show(message, type = 'info', duration = 4000) {
                this.init();

                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('tabindex', '-1');

                const icon = document.createElement('span');
                icon.className = 'toast-icon';
                icon.textContent = this.getIcon(type);
                icon.setAttribute('aria-hidden', 'true');

                const content = document.createElement('div');
                content.className = 'toast-content';

                const msg = document.createElement('div');
                msg.className = 'toast-message';
                msg.textContent = message;

                const closeBtn = document.createElement('button');
                closeBtn.className = 'toast-close';
                closeBtn.innerHTML = '√ó';
                closeBtn.setAttribute('aria-label', 'Fermer la notification');
                closeBtn.onclick = () => this.close(toast);

                const progress = document.createElement('div');
                progress.className = 'toast-progress';
                progress.style.animationDuration = `${duration}ms`;

                content.appendChild(msg);
                toast.appendChild(icon);
                toast.appendChild(content);
                toast.appendChild(closeBtn);
                toast.appendChild(progress);

                this.container.appendChild(toast);
                toast.focus();

                if (duration > 0) {
                    setTimeout(() => this.close(toast), duration);
                }

                return toast;
            },

            close(toast) {
                if (!toast || toast.classList.contains('toast-closing')) return;
                toast.classList.add('toast-closing');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            },

            success(message, duration) {
                return this.show(message, 'success', duration);
            },

            error(message, duration) {
                return this.show(message, 'error', duration);
            },

            warning(message, duration) {
                return this.show(message, 'warning', duration);
            },

            info(message, duration) {
                return this.show(message, 'info', duration);
            }
        };

        // Fonction globale simplifi√©e pour remplacer alert()
        function showPopup(message, type = 'info', duration = 4000) {
            return ToastManager.show(message, type, duration);
        }

        // ============================================================
        // SYST√àME DE MODAL DE CONFIRMATION
        // ============================================================
        const ConfirmModal = {
            show(options) {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirmModal');
                    const title = document.getElementById('confirmModalTitle');
                    const message = document.getElementById('confirmModalMessage');
                    const subtext = document.getElementById('confirmModalSubtext');
                    const cancelBtn = document.getElementById('confirmModalCancel');
                    const confirmBtn = document.getElementById('confirmModalConfirm');

                    // Configuration du modal
                    title.textContent = options.title || 'Confirmation';
                    message.innerHTML = options.message || 'Es-tu s√ªr ?';

                    if (options.subtext) {
                        subtext.textContent = options.subtext;
                        subtext.style.display = 'block';
                    } else {
                        subtext.style.display = 'none';
                    }

                    cancelBtn.textContent = options.cancelText || 'Annuler';
                    confirmBtn.textContent = options.confirmText || 'Confirmer';

                    // Style du bouton confirmer (danger ou normal)
                    if (options.danger) {
                        confirmBtn.style.background = '#8B0000';
                        confirmBtn.style.color = '#FFE5E5';
                    } else {
                        confirmBtn.style.background = '';
                        confirmBtn.style.color = '';
                    }

                    // Handlers
                    const handleConfirm = () => {
                        cleanup();
                        resolve(true);
                    };

                    const handleCancel = () => {
                        cleanup();
                        resolve(false);
                    };

                    const cleanup = () => {
                        modal.classList.remove('active');
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };

                    confirmBtn.addEventListener('click', handleConfirm);
                    cancelBtn.addEventListener('click', handleCancel);

                    modal.classList.add('active');
                });
            }
        };

        // ============================================================
        // AUTHENTICATION FUNCTIONS
        // ============================================================

        // Basculer entre les onglets de connexion et d'inscription
        function showAuthTab(tab) {
            // G√©rer les onglets
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('auth-login').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('auth-signup').classList.add('active');
            }
        }

        // G√©rer l'inscription
        async function handleSignup() {
            if (!isFirebaseConfigured) {
                showPopup('Firebase n\'est pas configur√©. Consultez la documentation pour configurer Firebase.', 'warning');
                return;
            }

            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;
            const errorEl = document.getElementById('signup-error');

            errorEl.textContent = '';
            errorEl.classList.remove('show');

            // Validations
            if (!email || !password || !confirm) {
                errorEl.textContent = 'Tous les champs sont requis';
                errorEl.classList.add('show');
                return;
            }

            // Validation de l'email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorEl.textContent = 'Adresse e-mail invalide';
                errorEl.classList.add('show');
                return;
            }

            if (password !== confirm) {
                errorEl.textContent = 'Les mots de passe ne correspondent pas';
                errorEl.classList.add('show');
                return;
            }

            if (password.length < 8) {
                errorEl.textContent = 'Le mot de passe doit contenir au moins 8 caract√®res';
                errorEl.classList.add('show');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                console.log('‚úÖ Compte cr√©√©:', userCredential.user.uid);

                // Cr√©er le profil utilisateur dans Firestore
                await createUserProfile(userCredential.user);

                // V√©rifier si migration n√©cessaire
                checkLocalStorageMigration(userCredential.user);

                // Lancer le tutoriel pour les nouveaux utilisateurs
                localStorage.removeItem('warriorTutorialCompleted');
                currentTutorialStep = 1;
                goToTutorialStep(1);
                showTutorial();

            } catch (error) {
                console.error('‚ùå Erreur inscription:', error);
                errorEl.textContent = getAuthErrorMessage(error.code);
                errorEl.classList.add('show');
            }
        }

        // G√©rer la connexion
        async function handleLogin() {
            if (!isFirebaseConfigured) {
                showPopup('Firebase n\'est pas configur√©. Consultez la documentation pour configurer Firebase.', 'warning');
                return;
            }

            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            errorEl.textContent = '';
            errorEl.classList.remove('show');

            if (!email || !password) {
                errorEl.textContent = 'Email et mot de passe requis';
                errorEl.classList.add('show');
                return;
            }

            // Validation de l'email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorEl.textContent = 'Adresse e-mail invalide';
                errorEl.classList.add('show');
                return;
            }

            if (password.length < 8) {
                errorEl.textContent = 'Le mot de passe doit contenir au moins 8 caract√®res';
                errorEl.classList.add('show');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Connexion r√©ussie');
            } catch (error) {
                console.error('‚ùå Erreur connexion:', error);
                errorEl.textContent = getAuthErrorMessage(error.code);
                errorEl.classList.add('show');
            }
        }

        // G√©rer la d√©connexion
        function handleLogout() {
            if (!isFirebaseConfigured) return;
            document.getElementById('logoutModal').classList.add('active');
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').classList.remove('active');
        }

        async function confirmLogout() {
            try {
                await auth.signOut();
                console.log('‚úÖ D√©connexion r√©ussie');
                closeLogoutModal();
            } catch (error) {
                console.error('‚ùå Erreur d√©connexion:', error);
                ToastManager.show('Erreur lors de la d√©connexion', 'error');
                closeLogoutModal();
            }
        }

        // R√©initialisation du mot de passe
        async function handleForgotPassword() {
            if (!isFirebaseConfigured) return;

            const email = document.getElementById('login-email').value.trim();

            if (!email) {
                showPopup('Entre ton email pour r√©initialiser ton mot de passe', 'warning');
                return;
            }

            const confirmed = await ConfirmModal.show({
                title: 'üìß R√âINITIALISATION',
                message: `Envoyer un email de r√©initialisation √† <strong>${email}</strong> ?`,
                confirmText: 'Envoyer',
                cancelText: 'Annuler'
            });

            if (confirmed) {
                try {
                    await auth.sendPasswordResetEmail(email);
                    showPopup('Email de r√©initialisation envoy√© ! V√©rifie ta bo√Æte mail (et les spams).', 'success');
                    console.log('‚úÖ Email de r√©initialisation envoy√© √†:', email);
                } catch (error) {
                    console.error('‚ùå Erreur r√©initialisation:', error);
                    const errorMessage = getAuthErrorMessage(error.code);
                    showPopup(errorMessage, 'error');
                }
            }
        }

        // Suppression du compte utilisateur
        function handleDeleteAccount() {
            if (!isFirebaseConfigured) return;

            const user = auth.currentUser;
            if (!user) {
                showPopup('Tu dois √™tre connect√© pour supprimer ton compte', 'error');
                return;
            }

            // Ouvrir le modal de suppression
            document.getElementById('deleteAccountInput').value = '';
            document.getElementById('deleteAccountModal').classList.add('active');
        }

        function closeDeleteAccountModal() {
            document.getElementById('deleteAccountModal').classList.remove('active');
        }

        async function confirmDeleteAccount() {
            const input = document.getElementById('deleteAccountInput').value.trim();

            if (input !== 'SUPPRIMER') {
                showPopup('Tu dois taper exactement "SUPPRIMER" pour confirmer', 'warning');
                return;
            }

            closeDeleteAccountModal();

            try {
                const userId = user.uid;

                // Supprimer toutes les donn√©es Firestore de l'utilisateur
                const batch = db.batch();

                // Supprimer les habitudes
                const habitsSnapshot = await db.collection('users').doc(userId).collection('habits').get();
                habitsSnapshot.forEach(doc => batch.delete(doc.ref));

                // Supprimer les completions
                const completionsSnapshot = await db.collection('users').doc(userId).collection('completions').get();
                completionsSnapshot.forEach(doc => batch.delete(doc.ref));

                // Supprimer les stats
                const statsSnapshot = await db.collection('users').doc(userId).collection('stats').get();
                statsSnapshot.forEach(doc => batch.delete(doc.ref));

                // Supprimer le document utilisateur
                batch.delete(db.collection('users').doc(userId));

                // Commit les suppressions
                await batch.commit();
                console.log('‚úÖ Donn√©es Firestore supprim√©es');

                // Supprimer le compte Firebase Auth
                await user.delete();
                console.log('‚úÖ Compte utilisateur supprim√©');

                // Nettoyer le localStorage
                localStorage.removeItem('warriorTracker');

                showPopup('Ton compte a √©t√© supprim√© d√©finitivement. Au revoir, WARRIOR. On esp√®re te revoir ! üí™', 'success', 6000);

            } catch (error) {
                console.error('‚ùå Erreur suppression compte:', error);

                if (error.code === 'auth/requires-recent-login') {
                    showPopup('Pour des raisons de s√©curit√©, tu dois te reconnecter avant de supprimer ton compte. D√©connecte-toi puis reconnecte-toi, et r√©essaie.', 'error', 6000);
                } else {
                    showPopup('Erreur lors de la suppression du compte : ' + error.message, 'error');
                }
            }
        }

        // Traduire les codes d'erreur Firebase en fran√ßais
        function getAuthErrorMessage(errorCode) {
            const messages = {
                'auth/email-already-in-use': 'Cet email est d√©j√† utilis√©',
                'auth/invalid-email': 'Email invalide',
                'auth/weak-password': 'Mot de passe trop faible',
                'auth/user-not-found': 'Utilisateur non trouv√©',
                'auth/wrong-password': 'Mot de passe incorrect',
                'auth/too-many-requests': 'Trop de tentatives. R√©essaie plus tard.',
                'auth/network-request-failed': 'Erreur r√©seau. V√©rifie ta connexion.'
            };
            return messages[errorCode] || 'Erreur d\'authentification : ' + errorCode;
        }

        // Cr√©er le profil utilisateur dans Firestore (sans habitudes par d√©faut)
        async function createUserProfile(user) {
            const userRef = db.collection('users').doc(user.uid);

            await userRef.set({
                email: user.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            });

            console.log('‚úÖ Profil utilisateur cr√©√© (l\'utilisateur doit ajouter ses propres habitudes)');
        }

        // Auth State Listener sera g√©r√© dans DOMContentLoaded

        // V√©rifier si migration localStorage n√©cessaire
        function checkLocalStorageMigration(user) {
            const localData = localStorage.getItem('warriorTracker');

            if (localData) {
                const data = JSON.parse(localData);
                const daysCount = Object.keys(data.days || {}).length;

                if (daysCount > 0) {
                    showMigrationModal(data, user);
                }
            }
        }

        // Afficher la modal de migration
        function showMigrationModal(localData, user) {
            const modal = document.getElementById('migrationModal');
            const preview = document.getElementById('migrationPreview');

            const daysCount = Object.keys(localData.days || {}).length;

            // Calculer les jours parfaits
            let perfectDays = 0;
            Object.values(localData.days || {}).forEach(day => {
                const completed = Object.values(day).filter(Boolean).length;
                if (completed === habits.length) perfectDays++;
            });

            preview.innerHTML = `
                <div class="migration-stat">
                    <span>Jours enregistr√©s</span>
                    <strong>${daysCount}</strong>
                </div>
                <div class="migration-stat">
                    <span>Jours parfaits</span>
                    <strong>${perfectDays}</strong>
                </div>
                <div class="migration-stat">
                    <span>Meilleure s√©rie</span>
                    <strong>${localData.stats?.bestStreak || 0}</strong>
                </div>
            `;

            modal.classList.add('active');

            // Stocker temporairement pour la migration
            window.pendingMigration = { localData, user };
        }

        // Effectuer la migration localStorage ‚Üí Firestore
        async function performMigration() {
            const { localData, user } = window.pendingMigration;

            try {
                console.log('üîÑ D√©but de la migration...');

                // Migration des completions
                let batch = db.batch();
                let batchCount = 0;

                for (const [dateKey, dayData] of Object.entries(localData.days || {})) {
                    for (const [habitId, completed] of Object.entries(dayData)) {
                        if (completed) {
                            const docId = `${dateKey}-${habitId}`;
                            const completionRef = db.collection('users').doc(user.uid)
                                .collection('completions').doc(docId);

                            batch.set(completionRef, {
                                date: dateKey,
                                habitId: habitId,
                                completed: true,
                                completedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            batchCount++;

                            // Firestore limite √† 500 op√©rations par batch
                            if (batchCount >= 400) {
                                await batch.commit();
                                console.log(`‚úÖ Migr√© ${batchCount} completions`);
                                batch = db.batch(); // Cr√©er un nouveau batch
                                batchCount = 0;
                            }
                        }
                    }
                }

                if (batchCount > 0) {
                    await batch.commit();
                    console.log(`‚úÖ Migr√© ${batchCount} completions`);
                }

                // Migration des stats
                const statsRef = db.collection('users').doc(user.uid).collection('stats').doc('global');
                await statsRef.set({
                    bestStreak: localData.stats?.bestStreak || 0,
                    totalWins: 0,
                    perfectDaysCount: 0,
                    lastCalculated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Migration des noms personnalis√©s
                if (localData.customHabitNames) {
                    const habitBatch = db.batch();
                    for (const [habitId, customName] of Object.entries(localData.customHabitNames)) {
                        const habitRef = db.collection('users').doc(user.uid)
                            .collection('habits').doc(habitId);
                        habitBatch.update(habitRef, { name: customName });
                    }
                    await habitBatch.commit();
                    console.log('‚úÖ Noms personnalis√©s migr√©s');
                }

                // Supprimer les donn√©es locales apr√®s migration r√©ussie
                localStorage.removeItem('warriorTracker');

                closeMigrationModal();
                showPopup('Migration r√©ussie ! Toutes tes donn√©es ont √©t√© transf√©r√©es.', 'success');
                console.log('‚úÖ Migration compl√®te');

            } catch (error) {
                console.error('‚ùå Erreur de migration:', error);
                showPopup('Erreur lors de la migration. Tes donn√©es locales sont conserv√©es.', 'error');
            }
        }

        // Ignorer la migration
        async function skipMigration() {
            closeMigrationModal();

            // Demander si on veut supprimer les donn√©es locales
            const confirmed = await ConfirmModal.show({
                title: 'üóëÔ∏è DONN√âES LOCALES',
                message: 'Veux-tu supprimer les donn√©es locales ?',
                confirmText: 'Supprimer',
                cancelText: 'Conserver',
                danger: true
            });

            if (confirmed) {
                localStorage.removeItem('warriorTracker');
                showPopup('Donn√©es locales supprim√©es', 'success');
            }
        }

        // Fermer la modal de migration
        function closeMigrationModal() {
            document.getElementById('migrationModal').classList.remove('active');
            window.pendingMigration = null;
        }

        // --- GESTION DE L'√âTAT ---
        let currentDate = new Date(); // La date actuellement affich√©e, initialis√©e √† aujourd'hui
        let weeklyChart, habitsChart; // Variables pour stocker les instances des graphiques

        // V√©rifie si une date est aujourd'hui
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // D√©termine si on peut modifier les habitudes pour une date donn√©e (seulement aujourd'hui et non valid√©)
        function canEditDate(date) {
            // Ne peut pas √©diter si ce n'est pas aujourd'hui
            if (!isToday(date)) return false;

            // Ne peut pas √©diter si le jour est d√©j√† valid√©
            if (isDayValidated(date)) return false;

            return true;
        }


        // --- GESTION DU STOCKAGE LOCAL ---

        // Cr√©e une cl√© de date unique (YYYY-MM-DD) pour le stockage
        function getDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // R√©cup√®re toutes les donn√©es depuis le localStorage
        function getData() {
            const data = localStorage.getItem('warriorTracker');
            return data ? JSON.parse(data) : { days: {}, stats: { bestStreak: 0 } };
        }

        // Sauvegarde les donn√©es dans le localStorage
        function saveData(data) {
            localStorage.setItem('warriorTracker', JSON.stringify(data));
        }

        // R√©cup√®re les donn√©es d'un jour sp√©cifique
        function getDayData(date) {
            const data = getData();
            const key = getDateKey(date);
            return data.days[key] || {};
        }

        // Met √† jour le statut (coch√©/d√©coch√©) d'une habitude pour aujourd'hui
        function setHabitStatus(habitId, checked) {
            if (!canEditDate(currentDate)) { // Bloque la modification si ce n'est pas aujourd'hui
                return;
            }
            const data = getData();
            const key = getDateKey(currentDate);
            if (!data.days[key]) data.days[key] = {}; // Cr√©e un objet pour le jour s'il n'existe pas
            data.days[key][habitId] = checked;
            saveData(data);
            updateUI(); // Met √† jour l'interface utilisateur
        }


        // --- CALCULS ET LOGIQUE M√âTIER ---

        // Calcule le score (en %) d'un jour donn√©
        function getDayScore(date) {
            if (habits.length === 0) return 0;

            // Filtrer les habitudes planifi√©es pour ce jour
            const scheduledHabits = habits.filter(h => isHabitScheduledForDate(h, date));
            if (scheduledHabits.length === 0) return 100; // Jour de repos = 100%

            const dayData = getDayData(date);
            const completed = scheduledHabits.filter(h => dayData[h.id]).length;
            return Math.round((completed / scheduledHabits.length) * 100);
        }

        // Calcule la s√©rie (streak) de jours cons√©cutifs avec un score >= 70%
        function getStreak() {
            let streak = 0;
            let date = new Date();
            date.setDate(date.getDate() - 1); // Commence par v√©rifier hier

            while (true) {
                const score = getDayScore(date);
                if (score >= 70) {
                    streak++;
                    date.setDate(date.getDate() - 1); // Passe au jour pr√©c√©dent
                } else {
                    break; // La s√©rie est rompue
                }
            }

            if (getDayScore(new Date()) >= 70) {
                streak++; // Ajoute aujourd'hui si le score est suffisant
            }
            return streak;
        }

        // Compte le nombre total de jours parfaits (100% des habitudes planifi√©es compl√©t√©es)
        function getPerfectDays() {
            const data = getData();
            let count = 0;
            for (const key in data.days) {
                // Recr√©er la date √† partir de la cl√© (format: YYYY-MM-DD)
                const [year, month, day] = key.split('-').map(Number);
                const date = new Date(year, month - 1, day);

                // Filtrer les habitudes planifi√©es pour ce jour
                const scheduledHabits = habits.filter(h => isHabitScheduledForDate(h, date));
                if (scheduledHabits.length === 0) continue; // Jour de repos ne compte pas

                const dayData = data.days[key];
                const completed = scheduledHabits.filter(h => dayData[h.id]).length;
                if (completed === scheduledHabits.length) count++;
            }
            return count;
        }

        // D√©termine le rang de l'utilisateur en fonction de son score moyen (utilise les rangs personnalisables)
        function getRank(score) {
            // S'assurer que les rangs sont charg√©s
            if (rankSettings.length === 0) {
                loadRankSettings();
            }

            // Parcourir les rangs du plus haut au plus bas pour trouver le rang correspondant
            for (let i = rankSettings.length - 1; i >= 0; i--) {
                if (score >= rankSettings[i].minScore) {
                    return {
                        name: rankSettings[i].name,
                        color: rankSettings[i].color
                    };
                }
            }

            // Fallback au premier rang si aucun ne correspond
            if (rankSettings.length > 0) {
                return {
                    name: rankSettings[0].name,
                    color: rankSettings[0].color
                };
            }

            // Fallback ultime
            return { name: 'D√âBUTANT', color: '#5A5A55' };
        }

        // Calcule la s√©rie pour une habitude sp√©cifique
        function getHabitStreak(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return 0;

            let streak = 0;
            let date = new Date();
            date.setDate(date.getDate() - 1); // Commence hier
            let maxDaysBack = 365; // Limite pour √©viter boucle infinie

            while (maxDaysBack > 0) {
                // V√©rifier si l'habitude √©tait planifi√©e ce jour
                if (isHabitScheduledForDate(habit, date)) {
                    const dayData = getDayData(date);
                    if (dayData[habitId]) {
                        streak++;
                    } else {
                        break; // S√©rie rompue
                    }
                }
                // Passer au jour pr√©c√©dent (m√™me si non planifi√©)
                date.setDate(date.getDate() - 1);
                maxDaysBack--;
            }

            // Ajouter aujourd'hui si planifi√© et compl√©t√©
            const today = new Date();
            if (isHabitScheduledForDate(habit, today) && getDayData(today)[habitId]) {
                streak++;
            }
            return streak;
        }

        // Calcule le score moyen pour le mois en cours
        function getMonthScore() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            let totalScore = 0;
            let daysWithData = 0;
            for (let d = new Date(startOfMonth); d <= now; d.setDate(d.getDate() + 1)) {
                const dayData = getDayData(d);
                if (Object.keys(dayData).length > 0) {
                    totalScore += getDayScore(new Date(d));
                    daysWithData++;
                }
            }
            return daysWithData > 0 ? Math.round(totalScore / daysWithData) : 0;
        }

        // Calcule le nombre total d'habitudes compl√©t√©es ("victoires")
        function getTotalWins() {
            const data = getData();
            let wins = 0;
            for (const key in data.days) {
                const dayData = data.days[key];
                wins += habits.filter(h => dayData[h.id]).length;
            }
            return wins;
        }

        // Calcule le score moyen global sur tous les jours enregistr√©s
        function getAvgScore() {
            const data = getData();
            const days = Object.keys(data.days);
            if (days.length === 0 || habits.length === 0) return 0;

            let total = 0;
            let validDays = 0;

            days.forEach(key => {
                // Recr√©er la date √† partir de la cl√© (format: YYYY-MM-DD)
                const [year, month, day] = key.split('-').map(Number);
                const date = new Date(year, month - 1, day);

                // Filtrer les habitudes planifi√©es pour ce jour
                const scheduledHabits = habits.filter(h => isHabitScheduledForDate(h, date));
                if (scheduledHabits.length === 0) return; // Jour de repos, ignorer

                const dayData = data.days[key];
                const completed = scheduledHabits.filter(h => dayData[h.id]).length;
                total += (completed / scheduledHabits.length) * 100;
                validDays++;
            });

            return validDays > 0 ? Math.round(total / validDays) : 0;
        }

        // R√©cup√®re la meilleure s√©rie enregistr√©e
        function getBestStreak() {
            const data = getData();
            return data.stats?.bestStreak || getStreak();
        }

        // --- MISE √Ä JOUR DE L'INTERFACE UTILISATEUR (UI) ---

        // Formate une date en cha√Æne de caract√®res (ex: "lun. 28 d√©c.")
        function formatDate(date) {
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            return date.toLocaleDateString('fr-FR', options);
        }

        // V√©rifie si une habitude est planifi√©e pour une date donn√©e
        function isHabitScheduledForDate(habit, date) {
            // Compatibilit√©: les habitudes sans scheduleType sont consid√©r√©es quotidiennes
            const scheduleType = habit.scheduleType || 'daily';

            if (scheduleType === 'daily') {
                return true;
            }

            // Pour les habitudes hebdomadaires, v√©rifier si le jour est dans daysOfWeek
            const daysOfWeek = habit.daysOfWeek || [0, 1, 2, 3, 4, 5, 6];
            const dayOfWeek = date.getDay(); // 0 = Dimanche, 1 = Lundi, etc.

            return daysOfWeek.includes(dayOfWeek);
        }

        // Change la date affich√©e (jour pr√©c√©dent/suivant)
        function changeDate(delta) {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + delta);
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            if (newDate > today) { // Emp√™che de naviguer dans le futur
                return;
            }
            currentDate = newDate;
            updateUI();
        }

        function getCustomHabitNames() {
            const data = getData();
            return data.customHabitNames || {};
        }

        function getHabitDisplayName(habit) {
            const customNames = getCustomHabitNames();
            return customNames[habit.id] || habit.name;
        }

        // G√©n√®re et affiche la liste des habitudes pour la date actuelle
        function renderHabits() {
            const container = document.getElementById('habitsList');
            const dayData = getDayData(currentDate);
            const locked = !canEditDate(currentDate); // Verrouille si ce n'est pas aujourd'hui

            // Message si aucune habitude
            if (habits.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--accent-dim);">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üéØ</div>
                        <div style="font-size: 1.1rem; color: var(--accent); margin-bottom: 10px; font-weight: bold;">
                            AUCUNE HABITUDE
                        </div>
                        <div style="font-size: 0.85rem; margin-bottom: 20px; line-height: 1.5;">
                            Cr√©e tes propres habitudes pour commencer !
                        </div>
                        <button class="reset-btn edit-habits-btn" onclick="openManageHabitsModal()" style="max-width: 250px; margin: 0 auto;">
                            ‚ûï CR√âER MA PREMI√àRE HABITUDE
                        </button>
                    </div>
                `;
                return;
            }

            // Filtrer les habitudes planifi√©es pour ce jour
            const scheduledHabits = habits.filter(habit => isHabitScheduledForDate(habit, currentDate));

            // Message si aucune habitude planifi√©e pour ce jour
            if (scheduledHabits.length === 0) {
                const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                const dayName = dayNames[currentDate.getDay()];
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--accent-dim);">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üòå</div>
                        <div style="font-size: 1.1rem; color: var(--accent); margin-bottom: 10px; font-weight: bold;">
                            JOUR DE REPOS
                        </div>
                        <div style="font-size: 0.85rem; margin-bottom: 20px; line-height: 1.5;">
                            Aucune habitude planifi√©e pour ${dayName}.
                        </div>
                    </div>
                `;
                return;
            }

            // D√©terminer si c'est un jour pass√© (pas aujourd'hui)
            const isPastDay = !isToday(currentDate);

            container.innerHTML = scheduledHabits.map(habit => {
                const checked = dayData[habit.id] || false;
                const streak = getHabitStreak(habit.id);
                const monthData = getHabitMonthProgress(habit.id);
                const displayName = getHabitDisplayName(habit);
                const description = habit.description || '';
                const escapedId = habit.id.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                const onclickAttr = locked ? '' : `onclick="toggleHabit('${escapedId}')"`;

                // D√©terminer le statut : completed (vert), failed (rouge sur jours pass√©s), ou normal
                const isFailed = isPastDay && !checked;
                const streakText = locked ? (isFailed ? '‚ùå Non fait' : '‚úÖ Fait') : `üî• S√©rie: ${streak} jours`;

                // Classes CSS
                let itemClasses = 'habit-item';
                let checkboxClasses = 'habit-checkbox';

                if (locked) {
                    itemClasses += ' locked';
                    checkboxClasses += ' locked';
                }
                if (checked) {
                    itemClasses += ' completed';
                    checkboxClasses += ' checked';
                } else if (isFailed) {
                    itemClasses += ' failed';
                    checkboxClasses += ' failed';
                }

                // Afficher la description si elle existe
                const descriptionHtml = description
                    ? `<div class="habit-description">${description}</div>`
                    : '';

                return `
                    <div class="${itemClasses}" ${onclickAttr}>
                        <div class="${checkboxClasses}"></div>
                        <div class="habit-info">
                            <div class="habit-name">${habit.icon} ${displayName}</div>
                            ${descriptionHtml}
                            <div class="habit-streak">${streakText}</div>
                        </div>
                        <div class="habit-progress">
                            <div class="percent">${monthData}%</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Calcule le pourcentage de compl√©tion d'une habitude pour le mois en cours
        function getHabitMonthProgress(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return 0;

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const dayOfMonth = now.getDate();

            let completed = 0;
            let scheduledDays = 0;

            // Parcourir chaque jour du mois jusqu'√† aujourd'hui
            for (let day = 1; day <= dayOfMonth; day++) {
                const d = new Date(year, month, day);

                // Ne compter que les jours o√π l'habitude √©tait planifi√©e
                if (isHabitScheduledForDate(habit, d)) {
                    scheduledDays++;
                    const dayData = getDayData(d);
                    if (dayData[habitId]) {
                        completed++;
                    }
                }
            }

            return scheduledDays > 0 ? Math.round((completed / scheduledDays) * 100) : 100;
        }

        // ============================================================
        // SYST√àME DE SON - FEEDBACK AUDIO
        // ============================================================

        // Contexte audio pour les sons
        let audioContext = null;

        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        // Son de VICTOIRE quand on coche une habitude
        function playSuccessSound() {
            try {
                const ctx = getAudioContext();
                const now = ctx.currentTime;

                // Cr√©er un son de "ding" satisfaisant
                const oscillator1 = ctx.createOscillator();
                const oscillator2 = ctx.createOscillator();
                const gainNode = ctx.createGain();

                // Fr√©quences pour un son de victoire (accord majeur)
                oscillator1.frequency.setValueAtTime(880, now); // La5
                oscillator1.frequency.setValueAtTime(1108.73, now + 0.1); // Do#6
                oscillator2.frequency.setValueAtTime(1318.51, now); // Mi6

                oscillator1.type = 'sine';
                oscillator2.type = 'sine';

                // Envelope du volume
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);

                // Connexions
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(ctx.destination);

                // Jouer
                oscillator1.start(now);
                oscillator2.start(now);
                oscillator1.stop(now + 0.4);
                oscillator2.stop(now + 0.4);

            } catch (e) {
                console.log('Audio non disponible:', e);
            }
        }

        // Son d'√âCHEC quand on d√©coche (optionnel, plus discret)
        function playUndoSound() {
            try {
                const ctx = getAudioContext();
                const now = ctx.currentTime;

                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.frequency.setValueAtTime(300, now);
                oscillator.frequency.linearRampToValueAtTime(200, now + 0.15);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.15, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.start(now);
                oscillator.stop(now + 0.15);

            } catch (e) {
                console.log('Audio non disponible:', e);
            }
        }

        // G√®re le clic sur une habitude pour la cocher/d√©cocher
        function toggleHabit(habitId) {
            const dayData = getDayData(currentDate);
            const newStatus = !dayData[habitId];
            setHabitStatus(habitId, newStatus);

            // Feedback audio
            if (newStatus) {
                playSuccessSound(); // Son de victoire
            } else {
                playUndoSound(); // Son discret de d√©cochage
            }

            // Vibration pour le retour haptique
            if (navigator.vibrate) {
                navigator.vibrate(newStatus ? [30, 30, 30] : 20);
            }

            if (newStatus) {
                const completed = habits.filter(h => getDayData(currentDate)[h.id]).length;
                if (completed === habits.length) {
                    triggerConfetti(); // Lance des confettis si toutes les habitudes sont compl√©t√©es
                }
            }
        }

        // D√©clenche une animation de confettis
        function triggerConfetti() {
            const colors = ['#F5F5F0', '#D4D4CF', '#A3A39E'];
            const confettiCount = 50;
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position: fixed; width: 10px; height: 10px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    left: ${Math.random() * 100}vw; top: -10px;
                    border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                    pointer-events: none; z-index: 9999;
                    animation: confettiFall ${2 + Math.random() * 2}s linear forwards;
                    animation-delay: ${Math.random() * 0.5}s;
                `;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
            if (navigator.vibrate) {
                navigator.vibrate([50, 50, 50, 50, 100]);
            }
        }

        // Met √† jour les KPIs (score, streak, etc.) sur la page "Aujourd'hui"
        function updateKPIs() {
            const dayData = getDayData(currentDate);
            const completed = habits.filter(h => dayData[h.id]).length;
            const score = getDayScore(currentDate);
            const locked = !canEditDate(currentDate);

            document.getElementById('dailyScore').textContent = score + '%';
            document.getElementById('currentStreak').textContent = getStreak();
            document.getElementById('perfectDays').textContent = getPerfectDays();
            document.getElementById('completedCount').textContent = locked ? 'üîí VERROUILL√â' : `${completed}/${habits.length}`;
            document.getElementById('currentDate').textContent = formatDate(currentDate) + (locked ? ' üîí' : '');

            // Met √† jour la meilleure s√©rie si la s√©rie actuelle est plus longue
            const data = getData();
            const currentStreak = getStreak();
            if (currentStreak > (data.stats?.bestStreak || 0)) {
                data.stats = data.stats || {};
                data.stats.bestStreak = currentStreak;
                saveData(data);
            }
        }

        // Met √† jour tous les √©l√©ments de la page "Stats"
        function updateStats() {
            const avgScore = getAvgScore();
            const rank = getRank(avgScore);

            document.getElementById('rankName').textContent = rank.name;
            document.getElementById('rankName').style.color = rank.color;
            document.getElementById('rankProgress').style.width = avgScore + '%';
            document.getElementById('monthScore').textContent = getMonthScore() + '%';
            document.getElementById('bestStreak').textContent = getBestStreak();
            document.getElementById('totalWins').textContent = getTotalWins();
            document.getElementById('avgScore').textContent = avgScore + '%';

            renderWeeklyGrid();
            renderCharts();

            // V√©rifier et d√©bloquer les nouveaux badges
            checkAndUnlockBadges();
            renderBadges();
        }

        // G√©n√®re et affiche la grille des scores de la semaine
        function renderWeeklyGrid() {
            const container = document.getElementById('weeklyGrid');
            const today = new Date();
            const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            let html = '';
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const score = getDayScore(date);
                html += `
                    <div class="weekly-day ${i === 0 ? 'today' : ''} ${score === 100 ? 'perfect' : ''}">
                        <div class="day-name">${dayNames[date.getDay()]}</div>
                        <div class="day-score">${score}%</div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // G√©n√®re et met √† jour les graphiques
        function renderCharts() {
            // Graphique de score hebdomadaire
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            const weeklyData = [];
            const weeklyLabels = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                weeklyLabels.push(date.getDate() + '/' + (date.getMonth() + 1));
                weeklyData.push(getDayScore(date));
            }
            if (weeklyChart) weeklyChart.destroy();
            weeklyChart = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: weeklyLabels,
                    datasets: [{
                        data: weeklyData,
                        borderColor: '#F5F5F0',
                        backgroundColor: 'rgba(245, 245, 240, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 0, max: 100, ticks: { color: '#A3A39E' }, grid: { color: '#2D2D2D' } }, x: { ticks: { color: '#A3A39E' }, grid: { color: '#2D2D2D' } } }
                }
            });

            // Graphique de performance par habitude
            const habitsCtx = document.getElementById('habitsChart').getContext('2d');
            const habitsData = habits.map(h => getHabitMonthProgress(h.id));
            if (habitsChart) habitsChart.destroy();
            habitsChart = new Chart(habitsCtx, {
                type: 'bar',
                data: {
                    labels: habits.map(h => h.icon),
                    datasets: [{
                        data: habitsData,
                        backgroundColor: habitsData.map(v => v >= 80 ? '#F5F5F0' : v >= 50 ? '#A3A39E' : '#5A5A55'),
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 0, max: 100, ticks: { color: '#A3A39E' }, grid: { color: '#2D2D2D' } }, x: { ticks: { color: '#F5F5F0', font: { size: 16 } }, grid: { display: false } } }
                }
            });
        }

        // G√®re l'affichage des diff√©rentes pages (Aujourd'hui, Stats, Motivation)

        function showPage(page, event) {

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));



            const pageElement = document.getElementById('page-' + page);

            if (pageElement) {

                pageElement.classList.add('active');

            }



            if (event && event.currentTarget) {

                event.currentTarget.classList.add('active');

            }





            if (page === 'stats') {

                updateStats();

            } else if (page === 'motivation') {

                const quote = quotes[Math.floor(Math.random() * quotes.length)];

                document.getElementById('dailyQuote').textContent = '"' + quote.text + '"';

                document.getElementById('quoteAuthor').textContent = '- ' + quote.author;

            }

        }



        // FONCTIONS BOUCHONS POUR LES FONCTIONNALIT√âS NON IMPLEMENT√âES

        function openManageHabitsModal() { showPopup('La gestion des habitudes est en cours de d√©veloppement.', 'info'); }

        function closeManageHabitsModal() { console.log("closeManageHabitsModal called"); }

        function toggleAddHabitForm() { showPopup('La gestion des habitudes est en cours de d√©veloppement.', 'info'); }

        function cancelAddHabit() { console.log("cancelAddHabit called"); }

        function saveNewHabit() { showPopup('La gestion des habitudes est en cours de d√©veloppement.', 'info'); }

        function renderHabitsManagementList() { console.log("renderHabitsManagementList called"); }

        function setupIconPicker() { console.log("setupIconPicker called"); }

        function setupColorPicker() { console.log("setupColorPicker called"); }

        function resetAddHabitForm() { console.log("resetAddHabitForm called"); }

        function updateHabitName(id) { showPopup('La gestion des habitudes est en cours de d√©veloppement.', 'info'); }

        function deleteHabit(id) { showPopup('La gestion des habitudes est en cours de d√©veloppement.', 'info'); }

        function moveHabit(id, dir) { showPopup('La gestion des habitudes est en cours de d√©veloppement.', 'info'); }



        // R√©initialise toutes les donn√©es de l'application apr√®s confirmation
        async function resetAllData() {
            const firstConfirm = await ConfirmModal.show({
                title: '‚ö†Ô∏è R√âINITIALISATION',
                message: 'Es-tu s√ªr de vouloir tout r√©initialiser ?',
                subtext: 'Cette action est irr√©versible !',
                confirmText: 'Continuer',
                cancelText: 'Annuler',
                danger: true
            });

            if (!firstConfirm) return;

            const secondConfirm = await ConfirmModal.show({
                title: 'üî• DERNI√àRE CHANCE',
                message: 'Vraiment TOUT supprimer ?',
                subtext: 'Toutes tes donn√©es seront perdues d√©finitivement.',
                confirmText: 'Supprimer tout',
                cancelText: 'Annuler',
                danger: true
            });

            if (secondConfirm) {
                localStorage.removeItem('warriorTracker');
                updateUI();
                showPopup('Donn√©es r√©initialis√©es.', 'success');
            }
        }

        // Fonction principale de mise √† jour de l'UI
        function updateUI() {
            renderHabits();
            updateKPIs();
            updateValidateButton();
        }

        // --- √âDITION DES HABITUDES ---

        // ============================================================
        // HABIT MANAGEMENT FUNCTIONS (Gestion dynamique des habitudes)
        // ============================================================

        // Variables globales pour la gestion des habitudes
        let selectedIcon = 'üéØ';
        let selectedColor = '#F5F5F0';
        let selectedScheduleType = 'daily';
        let selectedDaysOfWeek = [0, 1, 2, 3, 4, 5, 6]; // Tous les jours par d√©faut

        // Ouvrir la modal de gestion des habitudes
        function openManageHabitsModal() {
            const modal = document.getElementById('manageHabitsModal');
            renderHabitsManagementList();
            modal.classList.add('active');

            // Reset formulaire d'ajout
            resetAddHabitForm();
        }

        // Fermer la modal de gestion
        function closeManageHabitsModal() {
            document.getElementById('manageHabitsModal').classList.remove('active');
            resetAddHabitForm();
            updateUI(); // Rafra√Æchir l'affichage principal
        }

        // Afficher/masquer le formulaire d'ajout
        function toggleAddHabitForm() {
            const section = document.getElementById('addHabitSection');
            const form = document.getElementById('addHabitForm');

            if (form.classList.contains('active')) {
                form.classList.remove('active');
                section.classList.add('collapsed');
            } else {
                form.classList.add('active');
                section.classList.remove('collapsed');
                setupIconPicker();
                setupColorPicker();
            }
        }

        // Configuration du s√©lecteur d'ic√¥nes
        function setupIconPicker() {
            const iconOptions = document.querySelectorAll('#iconPicker .icon-option');
            iconOptions.forEach(option => {
                option.addEventListener('click', function () {
                    iconOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedIcon = this.dataset.icon;
                });
            });

            // S√©lectionner la premi√®re ic√¥ne par d√©faut
            if (iconOptions.length > 0 && !document.querySelector('#iconPicker .icon-option.selected')) {
                iconOptions[0].classList.add('selected');
                selectedIcon = iconOptions[0].dataset.icon;
            }
        }

        // Configuration du s√©lecteur de couleurs
        function setupColorPicker() {
            const colorOptions = document.querySelectorAll('#colorPicker .color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', function () {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedColor = this.dataset.color;
                });
            });

            // S√©lectionner la premi√®re couleur par d√©faut
            if (colorOptions.length > 0 && !document.querySelector('#colorPicker .color-option.selected')) {
                colorOptions[0].classList.add('selected');
                selectedColor = colorOptions[0].dataset.color;
            }
        }

        // Configuration du type de planification (quotidien/hebdomadaire)
        function setScheduleType(type) {
            selectedScheduleType = type;

            // Mettre √† jour les boutons
            document.querySelectorAll('.schedule-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // Afficher/masquer le s√©lecteur de jours
            const daysOfWeekPicker = document.getElementById('daysOfWeekPicker');
            if (type === 'weekly') {
                daysOfWeekPicker.style.display = 'flex';
                // Si aucun jour n'est s√©lectionn√©, s√©lectionner tous par d√©faut
                if (selectedDaysOfWeek.length === 0) {
                    selectedDaysOfWeek = [1, 2, 3, 4, 5]; // Jours de semaine par d√©faut
                    updateDaysOfWeekUI();
                }
            } else {
                daysOfWeekPicker.style.display = 'none';
                selectedDaysOfWeek = [0, 1, 2, 3, 4, 5, 6]; // Tous les jours
            }
        }

        // Basculer un jour de la semaine
        function toggleDayOfWeek(day) {
            const index = selectedDaysOfWeek.indexOf(day);
            if (index > -1) {
                // Ne pas permettre de d√©s√©lectionner tous les jours
                if (selectedDaysOfWeek.length > 1) {
                    selectedDaysOfWeek.splice(index, 1);
                }
            } else {
                selectedDaysOfWeek.push(day);
            }
            updateDaysOfWeekUI();
        }

        // Mettre √† jour l'UI des jours de la semaine
        function updateDaysOfWeekUI() {
            document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                const day = parseInt(checkbox.dataset.day);
                checkbox.classList.toggle('selected', selectedDaysOfWeek.includes(day));
            });
        }

        // R√©initialiser le formulaire d'ajout
        function resetAddHabitForm() {
            const section = document.getElementById('addHabitSection');
            const form = document.getElementById('addHabitForm');

            form.classList.remove('active');
            section.classList.add('collapsed');
            document.getElementById('newHabitName').value = '';
            document.getElementById('newHabitDescription').value = '';

            // Reset s√©lections
            document.querySelectorAll('#iconPicker .icon-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('#colorPicker .color-option').forEach(opt => opt.classList.remove('selected'));

            selectedIcon = 'üéØ';
            selectedColor = '#F5F5F0';

            // Reset planification
            selectedScheduleType = 'daily';
            selectedDaysOfWeek = [0, 1, 2, 3, 4, 5, 6];
            document.querySelectorAll('.schedule-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === 'daily');
            });
            const daysOfWeekPicker = document.getElementById('daysOfWeekPicker');
            if (daysOfWeekPicker) {
                daysOfWeekPicker.style.display = 'none';
            }
            updateDaysOfWeekUI();
        }

        // Annuler l'ajout d'une habitude
        function cancelAddHabit() {
            resetAddHabitForm();
        }

        // Sauvegarder une nouvelle habitude
        function saveNewHabit() {
            const name = document.getElementById('newHabitName').value.trim().toUpperCase();
            const description = document.getElementById('newHabitDescription').value.trim();

            if (!name) {
                showPopup('Le nom de l\'habitude est requis', 'warning');
                return;
            }

            // G√©n√©rer un ID unique
            const habitId = 'habit_' + Date.now();

            // Ajouter l'habitude au tableau
            const newHabit = {
                id: habitId,
                name: name,
                description: description || '',
                icon: selectedIcon,
                color: selectedColor,
                scheduleType: selectedScheduleType,
                daysOfWeek: [...selectedDaysOfWeek]
            };

            habits.push(newHabit);

            // Sauvegarder dans localStorage (ou Firestore si configur√©)
            const data = getData();
            if (!data.customHabits) data.customHabits = [];
            data.customHabits.push(newHabit);
            saveData(data);

            // Feedback
            if (navigator.vibrate) navigator.vibrate([30, 30, 30]);
            showPopup(`Habitude "${name}" ajout√©e avec succ√®s !`, 'success');

            // Reset et refresh
            resetAddHabitForm();
            renderHabitsManagementList();
            updateUI();
        }

        // Afficher la liste des habitudes dans la modal
        function renderHabitsManagementList() {
            const container = document.getElementById('habitsManagementList');

            if (habits.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--accent-dim); padding: 20px;">Aucune habitude. Ajoute-en une !</p>';
                return;
            }

            container.innerHTML = habits.map((habit, index) => {
                const color = habit.color || '#F5F5F0';
                const disabledUp = index === 0 ? 'disabled' : '';
                const disabledDown = index === habits.length - 1 ? 'disabled' : '';
                const escapedName = (habit.name || '').replace(/"/g, '&quot;');
                const escapedDesc = (habit.description || '').replace(/"/g, '&quot;');
                const escapedId = habit.id.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

                // Planification - compatibilit√© avec les anciennes habitudes
                const scheduleType = habit.scheduleType || 'daily';
                const daysOfWeek = habit.daysOfWeek || [0, 1, 2, 3, 4, 5, 6];
                const dayLabels = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];

                const scheduleDisplay = scheduleType === 'daily'
                    ? 'üìÖ Tous les jours'
                    : 'üìÜ ' + daysOfWeek.sort((a,b) => a-b).map(d => dayLabels[d]).join(', ');

                return `
                    <div class="habit-management-item" data-habit-id="${habit.id}">
                        <div class="habit-management-header">
                            <div class="move-buttons">
                                <button class="move-btn" onclick="moveHabit('${escapedId}', -1)" ${disabledUp}>‚ñ≤</button>
                                <button class="move-btn" onclick="moveHabit('${escapedId}', 1)" ${disabledDown}>‚ñº</button>
                            </div>
                            <div class="habit-color-indicator" style="background: ${color};"></div>
                            <div class="habit-icon-display">${habit.icon}</div>
                            <input type="text" class="habit-name-input" id="name-${habit.id}" value="${escapedName}" placeholder="Nom de l'habitude">
                            <div class="habit-actions">
                                <button class="habit-action-btn" onclick="updateHabit('${escapedId}')">üíæ</button>
                                <button class="habit-action-btn delete" onclick="deleteHabit('${escapedId}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="habit-management-description">
                            <input type="text" class="habit-desc-input" id="desc-${habit.id}" value="${escapedDesc}" placeholder="Description (optionnel)" maxlength="150">
                        </div>
                        <div class="habit-management-schedule">
                            <div class="schedule-type-picker-mini" id="scheduleTypePicker-${habit.id}">
                                <button type="button" class="schedule-type-btn-mini ${scheduleType === 'daily' ? 'active' : ''}"
                                    data-type="daily" onclick="setHabitScheduleType('${escapedId}', 'daily')">
                                    üìÖ Quotidien
                                </button>
                                <button type="button" class="schedule-type-btn-mini ${scheduleType === 'weekly' ? 'active' : ''}"
                                    data-type="weekly" onclick="setHabitScheduleType('${escapedId}', 'weekly')">
                                    üìÜ Hebdo
                                </button>
                            </div>
                            <div class="days-of-week-picker-mini" id="daysOfWeekPicker-${habit.id}" style="display: ${scheduleType === 'weekly' ? 'flex' : 'none'};">
                                ${[1, 2, 3, 4, 5, 6, 0].map(d => `
                                    <div class="day-checkbox-mini ${daysOfWeek.includes(d) ? 'selected' : ''}"
                                        data-day="${d}" onclick="toggleHabitDayOfWeek('${escapedId}', ${d})">${dayLabels[d]}</div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Mettre √† jour une habitude (nom et description)
        function updateHabit(habitId) {
            const nameInput = document.getElementById(`name-${habitId}`);
            const descInput = document.getElementById(`desc-${habitId}`);
            const newName = nameInput.value.trim().toUpperCase();
            const newDesc = descInput ? descInput.value.trim() : '';

            if (!newName) {
                showPopup('Le nom ne peut pas √™tre vide', 'warning');
                return;
            }

            // Trouver l'habitude
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            // Mettre √† jour le nom et la description
            habit.name = newName;
            habit.description = newDesc;

            // Sauvegarder
            const data = getData();
            if (!data.customHabits) data.customHabits = [];

            const customHabit = data.customHabits.find(h => h.id === habitId);
            if (customHabit) {
                customHabit.name = newName;
                customHabit.description = newDesc;
            }

            saveData(data);

            // Feedback
            if (navigator.vibrate) navigator.vibrate([30, 30, 30]);
            showPopup('Habitude mise √† jour !', 'success');

            renderHabitsManagementList();
            updateUI();
        }

        // Fonction de compatibilit√© (ancien nom)
        function updateHabitName(habitId) {
            updateHabit(habitId);
        }

        // Changer le type de planification d'une habitude existante
        function setHabitScheduleType(habitId, type) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            habit.scheduleType = type;
            if (type === 'daily') {
                habit.daysOfWeek = [0, 1, 2, 3, 4, 5, 6];
            } else if (!habit.daysOfWeek || habit.daysOfWeek.length === 7) {
                habit.daysOfWeek = [1, 2, 3, 4, 5]; // Jours de semaine par d√©faut
            }

            // Sauvegarder
            saveHabitSchedule(habitId, habit.scheduleType, habit.daysOfWeek);

            // Mettre √† jour l'UI
            const picker = document.getElementById(`daysOfWeekPicker-${habitId}`);
            if (picker) {
                picker.style.display = type === 'weekly' ? 'flex' : 'none';
            }

            // Mettre √† jour les boutons
            const container = document.getElementById(`scheduleTypePicker-${habitId}`);
            if (container) {
                container.querySelectorAll('.schedule-type-btn-mini').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === type);
                });
            }

            renderHabitsManagementList();
        }

        // Basculer un jour pour une habitude existante
        function toggleHabitDayOfWeek(habitId, day) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            if (!habit.daysOfWeek) habit.daysOfWeek = [0, 1, 2, 3, 4, 5, 6];

            const index = habit.daysOfWeek.indexOf(day);
            if (index > -1) {
                if (habit.daysOfWeek.length > 1) {
                    habit.daysOfWeek.splice(index, 1);
                }
            } else {
                habit.daysOfWeek.push(day);
            }

            // Sauvegarder
            saveHabitSchedule(habitId, habit.scheduleType, habit.daysOfWeek);

            // Mettre √† jour l'UI du checkbox
            const checkbox = document.querySelector(`#daysOfWeekPicker-${habitId} .day-checkbox-mini[data-day="${day}"]`);
            if (checkbox) {
                checkbox.classList.toggle('selected', habit.daysOfWeek.includes(day));
            }
        }

        // Sauvegarder la planification d'une habitude
        function saveHabitSchedule(habitId, scheduleType, daysOfWeek) {
            const data = getData();
            if (!data.customHabits) data.customHabits = [];

            const customHabit = data.customHabits.find(h => h.id === habitId);
            if (customHabit) {
                customHabit.scheduleType = scheduleType;
                customHabit.daysOfWeek = [...daysOfWeek];
            }

            saveData(data);
        }

        // Supprimer une habitude
        async function deleteHabit(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            const confirmed = await ConfirmModal.show({
                title: 'üóëÔ∏è SUPPRIMER HABITUDE',
                message: `Supprimer "<strong>${habit.name}</strong>" ?`,
                subtext: "L'historique sera conserv√© mais l'habitude n'appara√Ætra plus.",
                confirmText: 'Supprimer',
                cancelText: 'Annuler',
                danger: true
            });

            if (!confirmed) return;

            // Retirer du tableau
            const index = habits.findIndex(h => h.id === habitId);
            if (index > -1) {
                habits.splice(index, 1);
            }

            // Sauvegarder
            const data = getData();

            // Retirer des habitudes personnalis√©es
            if (data.customHabits) {
                data.customHabits = data.customHabits.filter(h => h.id !== habitId);
            }

            // Marquer comme supprim√©e (pour historique)
            if (!data.deletedHabits) data.deletedHabits = [];
            data.deletedHabits.push(habitId);

            saveData(data);

            // Feedback
            if (navigator.vibrate) navigator.vibrate(50);
            showPopup(`Habitude "${habit.name}" supprim√©e`, 'success');

            renderHabitsManagementList();
            updateUI();
        }

        // D√©placer une habitude (haut/bas)
        function moveHabit(habitId, direction) {
            const index = habits.findIndex(h => h.id === habitId);
            if (index === -1) return;

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= habits.length) return;

            // Swap
            [habits[index], habits[newIndex]] = [habits[newIndex], habits[index]];

            // Sauvegarder l'ordre
            const data = getData();
            if (!data.habitOrder) data.habitOrder = [];
            data.habitOrder = habits.map(h => h.id);
            saveData(data);

            // Feedback
            if (navigator.vibrate) navigator.vibrate(20);

            renderHabitsManagementList();
            updateUI();
        }

        // Charger les habitudes depuis Firestore (pour utilisateurs connect√©s)
        async function loadHabitsFromFirestore() {
            if (!isFirebaseConfigured || !appState.currentUser) return;

            try {
                const userId = appState.currentUser.uid;
                const habitsSnapshot = await db.collection('users').doc(userId).collection('habits').get();

                // Vider le tableau habits
                habits.length = 0;

                // Charger toutes les habitudes actives
                const loadedHabits = [];
                habitsSnapshot.forEach(doc => {
                    const habitData = doc.data();
                    if (habitData.isActive !== false) {
                        loadedHabits.push({
                            id: doc.id,
                            name: habitData.name,
                            icon: habitData.icon,
                            color: habitData.color || '#F5F5F0'
                        });
                    }
                });

                // Trier par order
                loadedHabits.sort((a, b) => {
                    const orderA = habitsSnapshot.docs.find(d => d.id === a.id)?.data().order || 0;
                    const orderB = habitsSnapshot.docs.find(d => d.id === b.id)?.data().order || 0;
                    return orderA - orderB;
                });

                // Ajouter au tableau habits
                loadedHabits.forEach(habit => habits.push(habit));

                console.log(`‚úÖ ${habits.length} habitudes charg√©es depuis Firestore`);
            } catch (error) {
                console.error('‚ùå Erreur chargement habitudes Firestore:', error);
            }
        }

        // Charger les habitudes personnalis√©es au d√©marrage
        async function loadCustomHabits() {
            // Si Firebase configur√© et utilisateur connect√©, charger depuis Firestore
            if (isFirebaseConfigured && appState.currentUser) {
                await loadHabitsFromFirestore();
                return;
            }

            // Sinon, charger depuis localStorage
            const data = getData();

            // Charger les noms personnalis√©s
            if (data.customHabitNames) {
                Object.entries(data.customHabitNames).forEach(([habitId, customName]) => {
                    const habit = habits.find(h => h.id === habitId);
                    if (habit) {
                        habit.name = customName;
                    }
                });
            }

            // Charger les habitudes personnalis√©es ajout√©es
            if (data.customHabits && data.customHabits.length > 0) {
                data.customHabits.forEach(customHabit => {
                    // V√©rifier qu'elle n'existe pas d√©j√†
                    if (!habits.find(h => h.id === customHabit.id)) {
                        // V√©rifier qu'elle n'a pas √©t√© supprim√©e
                        if (!data.deletedHabits || !data.deletedHabits.includes(customHabit.id)) {
                            habits.push(customHabit);
                        }
                    }
                });
            }

            // Restaurer l'ordre
            if (data.habitOrder && data.habitOrder.length > 0) {
                const orderedHabits = [];
                data.habitOrder.forEach(habitId => {
                    const habit = habits.find(h => h.id === habitId);
                    if (habit) {
                        orderedHabits.push(habit);
                    }
                });
                // Ajouter les habitudes qui ne sont pas dans l'ordre (nouvelles)
                habits.forEach(habit => {
                    if (!orderedHabits.find(h => h.id === habit.id)) {
                        orderedHabits.push(habit);
                    }
                });
                // Remplacer le tableau
                habits.length = 0;
                habits.push(...orderedHabits);
            }
        }

        // Fermer la modale si on clique en dehors
        document.getElementById('manageHabitsModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeManageHabitsModal();
            }
        });


        // --- GESTION DES NOTIFICATIONS ---

        // Demande la permission d'envoyer des notifications
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Notifications non support√©es');
                return false;
            }
            if (Notification.permission === 'granted') return true;
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return false;
        }

        // Programme une notification quotidienne √† l'heure configur√©e
        function scheduleNotification() {
            const data = getData();
            const notifTime = data.notificationTime || '21:00'; // Par d√©faut 21h

            // Parser l'heure (format "HH:MM")
            const [hours, minutes] = notifTime.split(':').map(Number);

            const now = new Date();
            const target = new Date();
            target.setHours(hours, minutes, 0, 0);

            if (now > target) { // Si l'heure est d√©j√† pass√©e, programmer pour demain
                target.setDate(target.getDate() + 1);
            }

            const delay = target.getTime() - now.getTime();
            setTimeout(() => {
                sendNotification();
                scheduleNotification(); // Reprogramme pour le jour suivant
            }, delay);

            console.log(`‚è∞ Notification programm√©e dans ${Math.round(delay / 60000)} minutes (${notifTime})`);
        }

        // Envoie la notification avec un message personnalis√©
        function sendNotification() {
            if (Notification.permission !== 'granted') return;
            const dayData = getDayData(new Date());
            const completed = habits.filter(h => dayData[h.id]).length;
            const remaining = habits.length - completed;
            let title, body;
            if (remaining === 0) {
                title = "üèÜ L√âGENDE !"; body = "Tu as compl√©t√© toutes tes habitudes.";
            } else if (remaining <= 2) {
                title = "‚öîÔ∏è PRESQUE WARRIOR !"; body = `Plus que ${remaining} habitude${remaining > 1 ? 's' : ''} √† valider. Tu peux le faire !`;
            } else {
                title = "üî• RAPPEL WARRIOR"; body = `${remaining} habitudes restantes. Ne l√¢che rien !`;
            }
            const notification = new Notification(title, {
                body: body,
                icon: 'data:image/svg+xml,...', // (ic√¥ne SVG)
                tag: 'warrior-reminder',
                renotify: true
            });
            notification.onclick = () => { window.focus(); notification.close(); };

            // Afficher automatiquement le popup de validation
            setTimeout(() => {
                showValidateDayModal();
            }, 2000); // Attendre 2 secondes pour laisser l'utilisateur voir la notification
        }

        // Active ou d√©sactive les notifications via le bouton
        function toggleNotifications() {
            const data = getData();
            if (data.notificationsEnabled) {
                data.notificationsEnabled = false;
                saveData(data);
                showPopup('üîï Notifications d√©sactiv√©es', 'info');
            } else {
                requestNotificationPermission().then(granted => {
                    if (granted) {
                        data.notificationsEnabled = true;
                        saveData(data);
                        scheduleNotification();
                        const notifTime = data.notificationTime || '21:00';
                        showPopup(`üîî Notifications activ√©es ! Rappel √† ${notifTime}.`, 'success');
                    } else {
                        showPopup('‚ùå Permission refus√©e', 'error');
                    }
                });
            }
            updateNotificationButton();
        }

        // Met √† jour le texte du bouton de notifications
        function updateNotificationButton() {
            const btn = document.getElementById('notifBtn');
            if (btn) {
                const data = getData();
                btn.textContent = data.notificationsEnabled ? 'üîî Notifications ON' : 'üîï Notifications OFF';
            }
        }

        // --- VALIDATION DE JOURN√âE ---

        // Met √† jour l'heure de notification personnalis√©e
        function updateNotificationTime() {
            const timeInput = document.getElementById('notifTime');
            if (!timeInput) return;

            const time = timeInput.value; // Format: "HH:MM"
            const data = getData();
            data.notificationTime = time;
            saveData(data);

            console.log(`‚è∞ Heure de notification mise √† jour: ${time}`);

            // Reprogrammer la notification avec la nouvelle heure
            if (data.notificationsEnabled) {
                scheduleNotification();
            }
        }

        // --- SYST√àME DE TH√àMES ---

        // Charge le th√®me sauvegard√© et l'applique
        function loadTheme() {
            const data = getData();
            const theme = data.theme || 'dark'; // Th√®me sombre par d√©faut
            applyTheme(theme, false); // false = ne pas sauvegarder (d√©j√† charg√©)
        }

        // Applique un th√®me sp√©cifique
        function applyTheme(theme, shouldSave = true) {
            // Appliquer l'attribut data-theme au body
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }

            // Mettre √† jour la meta theme-color pour la barre du navigateur
            const metaThemeColor = document.querySelector('meta[name="theme-color"]');
            if (metaThemeColor) {
                metaThemeColor.setAttribute('content', theme === 'light' ? '#FFFFFF' : '#0A0A0A');
            }

            // Sauvegarder le th√®me
            if (shouldSave) {
                const data = getData();
                data.theme = theme;
                saveData(data);

                // Synchroniser avec Firestore si connect√©
                if (isFirebaseConfigured && appState.currentUser) {
                    syncThemeToFirestore(theme);
                }
            }

            // Mettre √† jour le bouton
            updateThemeButton(theme);
        }

        // Synchronise le th√®me avec Firestore
        async function syncThemeToFirestore(theme) {
            if (!isFirebaseConfigured || !appState.currentUser) return;

            try {
                const userRef = firebase.firestore().collection('users').doc(appState.currentUser.uid);
                await userRef.set({ theme: theme }, { merge: true });
                console.log('‚úÖ Th√®me synchronis√© avec Firestore:', theme);
            } catch (error) {
                console.error('‚ùå Erreur lors de la synchronisation du th√®me:', error);
            }
        }

        // Charge le th√®me depuis Firestore
        async function loadThemeFromFirestore(userId) {
            if (!userId || !isFirebaseConfigured) return;

            try {
                const userRef = firebase.firestore().collection('users').doc(userId);
                const userDoc = await userRef.get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.theme) {
                        // Appliquer le th√®me depuis Firestore
                        applyTheme(userData.theme, true); // true = sauvegarder aussi en local
                        console.log('‚úÖ Th√®me charg√© depuis Firestore:', userData.theme);
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement du th√®me depuis Firestore:', error);
            }
        }

        // Bascule entre les th√®mes clair et sombre
        function toggleTheme() {
            const data = getData();
            const currentTheme = data.theme || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            applyTheme(newTheme, true);

            // Afficher une notification
            const themeName = newTheme === 'light' ? 'clair' : 'sombre';
            showPopup(`üé® Th√®me ${themeName} activ√©`, 'success');
        }

        // Met √† jour le bouton de th√®me
        function updateThemeButton(theme) {
            const btn = document.getElementById('themeToggleBtn');
            const icon = document.getElementById('themeToggleIcon');
            const text = document.getElementById('themeToggleText');

            if (btn && icon && text) {
                if (theme === 'light') {
                    icon.textContent = '‚òÄÔ∏è';
                    text.textContent = 'Clair';
                } else {
                    icon.textContent = 'üåô';
                    text.textContent = 'Sombre';
                }
            }
        }

        // --- SYST√àME DE BADGES D'ACHIEVEMENTS ---

        // Calcule toutes les statistiques n√©cessaires pour les badges
        function calculateStats() {
            return {
                totalWins: getTotalWins(),
                perfectDaysCount: getPerfectDays(),
                bestStreak: getBestStreak(),
                avgScore: getAvgScore()
            };
        }

        // Liste compl√®te des badges disponibles
        const BADGES = [
            // Badges de progression
            { id: 'first_step', name: 'Premier Pas', desc: 'Compl√©ter 1 habitude', icon: 'üë£', condition: 'totalWins', value: 1, rarity: 'common' },
            { id: 'beginner', name: 'D√©butant', desc: '10 victoires', icon: 'üå±', condition: 'totalWins', value: 10, rarity: 'common' },
            { id: 'committed', name: 'Engag√©', desc: '50 victoires', icon: 'üí™', condition: 'totalWins', value: 50, rarity: 'uncommon' },
            { id: 'dedicated', name: 'D√©vou√©', desc: '100 victoires', icon: 'üî•', condition: 'totalWins', value: 100, rarity: 'uncommon' },
            { id: 'champion', name: 'Champion', desc: '500 victoires', icon: '‚ö°', condition: 'totalWins', value: 500, rarity: 'rare' },
            { id: 'legend', name: 'L√©gende', desc: '1000 victoires', icon: 'üëë', condition: 'totalWins', value: 1000, rarity: 'epic' },

            // Badges de perfection
            { id: 'first_perfect', name: 'Journ√©e Parfaite', desc: 'Premier jour √† 100%', icon: '‚≠ê', condition: 'perfectDays', value: 1, rarity: 'common' },
            { id: 'perfectionist', name: 'Perfectionniste', desc: '10 jours parfaits', icon: '‚ú®', condition: 'perfectDays', value: 10, rarity: 'uncommon' },
            { id: 'master_perfect', name: 'Ma√Ætre de la Perfection', desc: '30 jours parfaits', icon: 'üåü', condition: 'perfectDays', value: 30, rarity: 'rare' },
            { id: 'flawless', name: 'Impeccable', desc: '100 jours parfaits', icon: 'üíé', condition: 'perfectDays', value: 100, rarity: 'epic' },

            // Badges de streaks
            { id: 'streak_3', name: 'S√©rie de 3', desc: '3 jours cons√©cutifs', icon: 'üî•', condition: 'bestStreak', value: 3, rarity: 'common' },
            { id: 'streak_7', name: 'Semaine Compl√®te', desc: '7 jours cons√©cutifs', icon: 'üìÖ', condition: 'bestStreak', value: 7, rarity: 'uncommon' },
            { id: 'streak_30', name: 'Mois Complet', desc: '30 jours cons√©cutifs', icon: 'üóìÔ∏è', condition: 'bestStreak', value: 30, rarity: 'rare' },
            { id: 'streak_100', name: 'Centurion', desc: '100 jours cons√©cutifs', icon: 'üèõÔ∏è', condition: 'bestStreak', value: 100, rarity: 'epic' },
            { id: 'streak_365', name: 'Ann√©e Compl√®te', desc: '365 jours cons√©cutifs', icon: 'üéØ', condition: 'bestStreak', value: 365, rarity: 'legendary' },

            // Badges de rangs
            { id: 'rank_warrior', name: 'Guerrier', desc: 'Atteindre le rang Guerrier', icon: '‚öîÔ∏è', condition: 'rank', value: 'CONFIRM√â', rarity: 'uncommon' },
            { id: 'rank_elite', name: 'Elite', desc: 'Atteindre le rang Elite', icon: 'üõ°Ô∏è', condition: 'rank', value: 'EXPERT', rarity: 'rare' },
            { id: 'rank_legend', name: 'L√©gende Vivante', desc: 'Atteindre le rang maximum', icon: 'üèÜ', condition: 'rank', value: 'MA√éTRE', rarity: 'epic' },

            // Badges de personnalisation
            { id: 'customizer', name: 'Personnalisateur', desc: 'Cr√©er 5 habitudes', icon: 'üé®', condition: 'customHabits', value: 5, rarity: 'common' },
            { id: 'architect', name: 'Architecte', desc: 'Cr√©er 10 habitudes', icon: 'üèóÔ∏è', condition: 'customHabits', value: 10, rarity: 'uncommon' },

            // Badges sp√©ciaux
            { id: 'early_bird', name: 'L√®ve-T√¥t', desc: 'Valider 7 jours avant 8h', icon: 'üåÖ', condition: 'earlyValidations', value: 7, rarity: 'rare' },
            { id: 'night_owl', name: 'Oiseau de Nuit', desc: 'Valider 7 jours apr√®s 22h', icon: 'üåô', condition: 'lateValidations', value: 7, rarity: 'rare' },
            { id: 'collector', name: 'Collectionneur', desc: 'D√©bloquer 10 badges', icon: 'üéñÔ∏è', condition: 'badgesUnlocked', value: 10, rarity: 'epic' },
            { id: 'completionist', name: 'Compl√©tionniste', desc: 'D√©bloquer tous les badges', icon: 'üèÖ', condition: 'allBadges', value: true, rarity: 'legendary' }
        ];

        // Couleurs des raret√©s
        const RARITY_COLORS = {
            common: '#95A5A6',
            uncommon: '#3498DB',
            rare: '#9B59B6',
            epic: '#E67E22',
            legendary: '#F39C12'
        };

        // Charge les badges d√©bloqu√©s depuis le stockage
        function loadBadges() {
            const data = getData();
            return data.unlockedBadges || [];
        }

        // Sauvegarde les badges d√©bloqu√©s
        function saveBadges(unlockedBadges) {
            const data = getData();
            data.unlockedBadges = unlockedBadges;
            saveData(data);

            // Synchroniser avec Firestore si connect√©
            if (isFirebaseConfigured && appState.currentUser) {
                syncBadgesToFirestore(unlockedBadges);
            }
        }

        // Synchronise les badges avec Firestore
        async function syncBadgesToFirestore(unlockedBadges) {
            if (!isFirebaseConfigured || !appState.currentUser) return;

            try {
                const userRef = firebase.firestore().collection('users').doc(appState.currentUser.uid);
                await userRef.set({ unlockedBadges: unlockedBadges }, { merge: true });
                console.log('‚úÖ Badges synchronis√©s avec Firestore');
            } catch (error) {
                console.error('‚ùå Erreur sync badges:', error);
            }
        }

        // V√©rifie et d√©bloque les nouveaux badges
        function checkAndUnlockBadges() {
            try {
                const data = getData();
                const stats = calculateStats();
                const unlockedBadges = loadBadges();
                const newlyUnlocked = [];
                console.log('üîç Checking badges...', 'Stats:', stats);

                // Calculer les m√©triques n√©cessaires
                const totalWins = stats.totalWins || 0;
                const perfectDays = stats.perfectDaysCount || 0;
                const bestStreak = stats.bestStreak || 0;
                const customHabits = (data.customHabits || []).length;
                const currentRank = getRank(stats.avgScore);
                const badgesCount = unlockedBadges.length;

                // Calculer validations t√¥t/tard (si impl√©ment√©)
                const earlyValidations = data.earlyValidations || 0;
                const lateValidations = data.lateValidations || 0;

                BADGES.forEach(badge => {
                    // Si d√©j√† d√©bloqu√©, ignorer
                    if (unlockedBadges.includes(badge.id)) return;

                    let unlocked = false;

                    // V√©rifier selon la condition
                    switch (badge.condition) {
                        case 'totalWins':
                            unlocked = totalWins >= badge.value;
                            break;
                        case 'perfectDays':
                            unlocked = perfectDays >= badge.value;
                            break;
                        case 'bestStreak':
                            unlocked = bestStreak >= badge.value;
                            break;
                        case 'customHabits':
                            unlocked = customHabits >= badge.value;
                            break;
                        case 'rank':
                            unlocked = currentRank.name === badge.value;
                            break;
                        case 'earlyValidations':
                            unlocked = earlyValidations >= badge.value;
                            break;
                        case 'lateValidations':
                            unlocked = lateValidations >= badge.value;
                            break;
                        case 'badgesUnlocked':
                            unlocked = badgesCount >= badge.value;
                            break;
                        case 'allBadges':
                            unlocked = unlockedBadges.length === BADGES.length - 1; // -1 pour ce badge lui-m√™me
                            break;
                    }

                    if (unlocked) {
                        unlockedBadges.push(badge.id);
                        newlyUnlocked.push(badge);
                    }
                });

                // Sauvegarder si de nouveaux badges
                if (newlyUnlocked.length > 0) {
                    saveBadges(unlockedBadges);

                    // Afficher notifications pour chaque nouveau badge
                    newlyUnlocked.forEach(badge => {
                        showBadgeUnlockNotification(badge);
                    });
                }

                return newlyUnlocked;
            } catch (error) {
                console.error('‚ùå Error checking badges:', error);
                return [];
            }
        }

        // Affiche une notification de d√©blocage de badge
        function showBadgeUnlockNotification(badge) {
            const rarityColor = RARITY_COLORS[badge.rarity];

            // Animation confetti pour badges rares+
            if (['rare', 'epic', 'legendary'].includes(badge.rarity)) {
                triggerConfetti();
            }

            // Notification visuelle
            showPopup(`üéâ Badge d√©bloqu√© : ${badge.icon} ${badge.name}`, 'success');

            // Vibration
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }

            console.log(`üèÜ Badge d√©bloqu√©: ${badge.name}`);
        }

        // Affiche les badges dans la page Stats
        function renderBadges() {
            try {
                const container = document.getElementById('badgesContainer');
                if (!container) {
                    console.warn('‚ö†Ô∏è Badge container not found');
                    return;
                }

                const unlockedBadges = loadBadges();
                console.log('üèÜ Rendering badges:', unlockedBadges.length, 'unlocked');

                let html = '<div class="badges-grid">';

                BADGES.forEach(badge => {
                    const isUnlocked = unlockedBadges.includes(badge.id);
                    const rarityColor = RARITY_COLORS[badge.rarity];

                    html += `
                        <div class="badge-card ${isUnlocked ? 'unlocked' : 'locked'}"
                             style="border-color: ${rarityColor};"
                             title="${badge.desc}">
                            <div class="badge-icon ${isUnlocked ? '' : 'grayscale'}">${badge.icon}</div>
                            <div class="badge-name">${badge.name}</div>
                            <div class="badge-desc">${badge.desc}</div>
                            ${!isUnlocked ? '<div class="badge-lock">üîí</div>' : ''}
                        </div>
                    `;
                });

                html += '</div>';

                // Compteur de badges
                const progress = Math.round((unlockedBadges.length / BADGES.length) * 100);
                html = `
                    <div class="badges-header">
                        <div class="badges-title">üèÜ ACHIEVEMENTS</div>
                        <div class="badges-progress">
                            <span>${unlockedBadges.length} / ${BADGES.length}</span>
                            <div class="progress-bar-small">
                                <div class="progress-fill-small" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                ` + html;

                container.innerHTML = html;
                console.log('‚úÖ Badges rendered successfully');
            } catch (error) {
                console.error('‚ùå Error rendering badges:', error);
            }
        }

        // --- VALIDATION DE JOURN√âE ---

        // Affiche le modal de validation de journ√©e
        function showValidateDayModal() {
            const modal = document.getElementById('validateDayModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        // Ferme le modal de validation
        function closeValidateDayModal() {
            const modal = document.getElementById('validateDayModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Confirme et valide la journ√©e en cours
        function confirmValidateDay() {
            const data = getData();
            const today = getDateKey(new Date());

            // Initialiser le tableau des jours valid√©s si n√©cessaire
            if (!data.validatedDays) {
                data.validatedDays = [];
            }

            // V√©rifier si d√©j√† valid√©
            if (data.validatedDays.includes(today)) {
                closeValidateDayModal();
                showPopup('‚úÖ Cette journ√©e est d√©j√† valid√©e !', 'info');
                return;
            }

            // Ajouter le jour aux jours valid√©s
            data.validatedDays.push(today);
            saveData(data);

            // Fermer le modal
            closeValidateDayModal();

            // Feedback
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
            showPopup('‚úÖ Journ√©e valid√©e !', 'success');

            // Confettis si jour parfait
            const dayData = getDayData(new Date());
            const completed = habits.filter(h => dayData[h.id]).length;
            if (completed === habits.length && habits.length > 0) {
                triggerConfetti();
            }

            // Masquer le bouton de validation et mettre √† jour l'UI
            updateValidateButton();
            renderHabits(); // Re-render pour verrouiller la journ√©e

            // V√©rifier les nouveaux badges d√©bloqu√©s
            checkAndUnlockBadges();
        }

        // Met √† jour la visibilit√© du bouton de validation
        function updateValidateButton() {
            const btn = document.getElementById('validateDayBtn');
            if (!btn) return;

            // Masquer si aucune habitude cr√©√©e
            if (!habits || habits.length === 0) {
                btn.style.display = 'none';
                return;
            }

            const today = getDateKey(new Date());
            const currentDateKey = getDateKey(currentDate); // Utilise la variable globale currentDate

            // Afficher uniquement si on visualise aujourd'hui
            if (currentDateKey !== today) {
                btn.style.display = 'none';
                return;
            }

            // V√©rifier si d√©j√† valid√©
            const data = getData();
            if (!data.validatedDays) data.validatedDays = [];

            if (data.validatedDays.includes(today)) {
                btn.style.display = 'none';
            } else {
                btn.style.display = 'block';
            }
        }

        // V√©rifie si un jour est valid√©
        function isDayValidated(date) {
            const data = getData();
            if (!data.validatedDays) return false;
            const dateKey = getDateKey(date);
            return data.validatedDays.includes(dateKey);
        }

        // Charge l'heure de notification configur√©e dans l'input
        function loadNotificationTime() {
            const notifTimeInput = document.getElementById('notifTime');
            if (!notifTimeInput) return;

            const data = getData();
            const savedTime = data.notificationTime || '21:00';
            notifTimeInput.value = savedTime;
        }

        // --- DIVERS ---

        // Affiche un message de bienvenue diff√©rent selon l'heure
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 6) return "Debout t√¥t, GUERRIER !";
            if (hour < 12) return "Bonne matin√©e, WARRIOR !";
            if (hour < 18) return "Continue comme √ßa !";
            if (hour < 21) return "Finis en beaut√© !";
            return "Derni√®re ligne droite !";
        }


        // ============================================================
        // TUTORIEL ONBOARDING - SYST√àME INTERACTIF
        // ============================================================

        let currentTutorialStep = 1;
        const totalTutorialSteps = 6;

        // V√©rifie si c'est la premi√®re visite de l'utilisateur
        function isFirstTimeUser() {
            const data = localStorage.getItem('warriorTracker');
            const tutorialCompleted = localStorage.getItem('warriorTutorialCompleted');

            // Si le tutoriel a d√©j√† √©t√© compl√©t√©, ne pas l'afficher
            if (tutorialCompleted === 'true') {
                return false;
            }

            // Si l'utilisateur a d√©j√† des donn√©es, ne pas afficher le tutoriel
            if (data) {
                const parsedData = JSON.parse(data);
                if (parsedData.days && Object.keys(parsedData.days).length > 0) {
                    return false;
                }
            }

            return true;
        }

        // Affiche le tutoriel
        function showTutorial() {
            const overlay = document.getElementById('tutorialOverlay');
            if (overlay) {
                overlay.classList.add('active');
                createParticles();
                // Vibration d'accueil
                if (navigator.vibrate) {
                    navigator.vibrate([50, 100, 50]);
                }
            }
        }

        // Cache le tutoriel
        function hideTutorial() {
            const overlay = document.getElementById('tutorialOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        // Cr√©e les particules d'arri√®re-plan
        function createParticles() {
            const container = document.getElementById('tutorialParticles');
            if (!container) return;

            container.innerHTML = '';

            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + 'vw';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                particle.style.opacity = 0.1 + Math.random() * 0.3;
                particle.style.width = (2 + Math.random() * 4) + 'px';
                particle.style.height = particle.style.width;
                container.appendChild(particle);
            }
        }

        // Navigation vers l'√©tape suivante
        function nextTutorialStep() {
            if (currentTutorialStep < totalTutorialSteps) {
                goToTutorialStep(currentTutorialStep + 1);
            }
        }

        // Navigation vers l'√©tape pr√©c√©dente
        function prevTutorialStep() {
            if (currentTutorialStep > 1) {
                goToTutorialStep(currentTutorialStep - 1);
            }
        }

        // Aller √† une √©tape sp√©cifique
        function goToTutorialStep(stepNum) {
            // Cacher toutes les √©tapes
            document.querySelectorAll('.tutorial-step').forEach(step => {
                step.classList.remove('active');
            });

            // Afficher l'√©tape cible
            const targetStep = document.querySelector(`.tutorial-step[data-step="${stepNum}"]`);
            if (targetStep) {
                targetStep.classList.add('active');
            }

            // Mettre √† jour les dots de progression
            document.querySelectorAll('.progress-dot').forEach(dot => {
                const dotStep = parseInt(dot.dataset.step);
                dot.classList.remove('active', 'completed');

                if (dotStep === stepNum) {
                    dot.classList.add('active');
                } else if (dotStep < stepNum) {
                    dot.classList.add('completed');
                }
            });

            // Mettre √† jour le texte de progression
            const stepNumEl = document.getElementById('currentStepNum');
            if (stepNumEl) {
                stepNumEl.textContent = stepNum;
            }

            currentTutorialStep = stepNum;

            // Vibration feedback
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }

            // Reset demo checkbox si on revient √† l'√©tape 4
            if (stepNum === 4) {
                resetDemoCheckbox();
            }
        }

        // Skip le tutoriel
        async function skipTutorial() {
            const confirmed = await ConfirmModal.show({
                title: '‚è≠Ô∏è PASSER LE TUTORIEL',
                message: 'Es-tu s√ªr de vouloir passer le tutoriel ?',
                subtext: 'Tu peux toujours le revoir plus tard dans les param√®tres.',
                confirmText: 'Passer',
                cancelText: 'Annuler'
            });

            if (confirmed) {
                completeTutorialAndContinue();
            }
        }

        // Compl√®te le tutoriel et redirige vers l'inscription
        function completeTutorial() {
            // Marquer le tutoriel comme compl√©t√©
            localStorage.setItem('warriorTutorialCompleted', 'true');

            // Animation de fermeture
            const overlay = document.getElementById('tutorialOverlay');
            if (overlay) {
                overlay.style.animation = 'tutorialFadeOut 0.5s ease-out forwards';

                setTimeout(() => {
                    hideTutorial();
                    overlay.style.animation = '';

                    // Confettis de bienvenue !
                    triggerConfetti();

                    // Vibration de victoire
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100, 50, 200]);
                    }
                }, 500);
            }
        }

        // Compl√®te le tutoriel sans animation sp√©ciale
        function completeTutorialAndContinue() {
            localStorage.setItem('warriorTutorialCompleted', 'true');
            hideTutorial();
        }

        // Demo checkbox toggle (√©tape 4)
        function toggleDemoCheckbox() {
            const checkbox = document.getElementById('demoCheckbox');
            const habitItem = document.getElementById('demoHabitItem');
            const instruction = document.getElementById('demoInstruction');
            const success = document.getElementById('demoSuccess');
            const percent = habitItem.querySelector('.demo-percent');
            const streak = habitItem.querySelector('.demo-habit-streak');

            if (!checkbox.classList.contains('checked')) {
                // Cocher
                checkbox.classList.add('checked');
                habitItem.classList.add('checked');
                instruction.style.display = 'none';
                success.classList.add('active');
                percent.textContent = '17%';
                streak.textContent = 'üî• S√©rie: 1 jour';

                // Vibration
                if (navigator.vibrate) {
                    navigator.vibrate([30, 30, 30]);
                }
            } else {
                // D√©cocher
                resetDemoCheckbox();
            }
        }

        // Reset demo checkbox
        function resetDemoCheckbox() {
            const checkbox = document.getElementById('demoCheckbox');
            const habitItem = document.getElementById('demoHabitItem');
            const instruction = document.getElementById('demoInstruction');
            const success = document.getElementById('demoSuccess');

            if (checkbox && habitItem && instruction && success) {
                checkbox.classList.remove('checked');
                habitItem.classList.remove('checked');
                instruction.style.display = 'flex';
                success.classList.remove('active');

                const percent = habitItem.querySelector('.demo-percent');
                const streak = habitItem.querySelector('.demo-habit-streak');
                if (percent) percent.textContent = '0%';
                if (streak) streak.textContent = 'üî• S√©rie: 0 jours';
            }
        }

        // Permet de relancer le tutoriel depuis les param√®tres
        function restartTutorial() {
            currentTutorialStep = 1;
            goToTutorialStep(1);
            showTutorial();
        }

        // Ajouter l'animation de sortie dans le style
        const tutorialFadeOutStyle = document.createElement('style');
        tutorialFadeOutStyle.textContent = `
            @keyframes tutorialFadeOut {
                from {
                    opacity: 1;
                    transform: scale(1);
                }
                to {
                    opacity: 0;
                    transform: scale(1.1);
                }
            }
        `;
        document.head.appendChild(tutorialFadeOutStyle);

        // Ajout des event listeners pour les dots de progression
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('progress-dot')) {
                const stepNum = parseInt(e.target.dataset.step);
                if (stepNum && stepNum <= currentTutorialStep + 1) {
                    goToTutorialStep(stepNum);
                }
            }
        });

        // --- INITIALISATION DE L'APPLICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Charger le th√®me imm√©diatement pour √©viter un flash
            loadTheme();

            async function initializeApp() {
                await loadCustomHabits();
                loadRankSettings(); // Charger les param√®tres de rangs
                renderRanks(false); // Afficher les rangs
                updateUI();
                const savedData = getData();
                if (savedData.notificationsEnabled && Notification.permission === 'granted') {
                    scheduleNotification();
                }
                document.querySelector('.header .quote').textContent = `"${getGreeting()}" - STAY HARD`;
                updateNotificationButton();
                loadNotificationTime(); // Charger l'heure de notification configur√©e
            }

            function showAppPage(pageName) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

                const pageElement = document.getElementById('page-' + pageName);
                if (pageElement) {
                    pageElement.classList.add('active');
                }
                const navItem = document.querySelector(`.nav-item[onclick*="'${pageName}'"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }

                // Masquer header et navigation si on est sur la page auth
                const header = document.querySelector('.header');
                const bottomNav = document.querySelector('.bottom-nav');
                if (pageName === 'auth') {
                    if (header) header.style.display = 'none';
                    if (bottomNav) bottomNav.style.display = 'none';
                } else {
                    if (header) header.style.display = 'block';
                    if (bottomNav) bottomNav.style.display = 'flex';
                }
            }

            // G√©rer l'affichage initial
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            if (!isFirebaseConfigured) {
                // Mode localStorage seul - afficher le tutoriel si premier utilisateur
                console.log("Mode localStorage seul activ√©.");
                document.getElementById('logoutBtn').style.display = 'none';

                // V√©rifier si c'est un nouvel utilisateur pour afficher le tutoriel
                if (isFirstTimeUser()) {
                    console.log("üéì Premier lancement d√©tect√© - Affichage du tutoriel");
                    showTutorial();
                }

                showAppPage('today');
                initializeApp();
            } else {
                // Mode Firebase - afficher la page auth en attendant la v√©rification
                showAppPage('auth');

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        appState.currentUser = user;
                        console.log('‚úÖ Utilisateur connect√©:', user.email);

                        // Mettre √† jour lastLogin
                        try {
                            await db.collection('users').doc(user.uid).update({
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } catch (error) {
                            console.warn('Erreur MAJ lastLogin:', error);
                        }

                        // Charger le th√®me depuis Firestore
                        await loadThemeFromFirestore(user.uid);

                        // V√©rifier s'il faut migrer les donn√©es localStorage
                        checkLocalStorageMigration(user);

                        document.getElementById('logoutBtn').style.display = 'block';
                        document.getElementById('deleteAccountBtn').style.display = 'block';
                        showAppPage('today');
                        await initializeApp();

                        // Afficher le tutoriel uniquement si l'utilisateur est connect√© et premier lancement
                        if (isFirstTimeUser()) {
                            console.log("üéì Premier lancement d√©tect√© - Affichage du tutoriel");
                            showTutorial();
                        }
                    } else {
                        appState.currentUser = null;
                        console.log('‚ö†Ô∏è Utilisateur non connect√©');
                        document.getElementById('logoutBtn').style.display = 'none';
                        document.getElementById('deleteAccountBtn').style.display = 'none';
                        showAppPage('auth');
                    }
                });
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch((err) => {
                    console.log('√âchec de l\'enregistrement du Service Worker:', err);
                });
            }
        });

        // ============================================================
        // CALENDRIER VISUEL - FONCTIONS
        // ============================================================

        let currentCalendarMonth = new Date();

        function openCalendarModal() {
            currentCalendarMonth = new Date(); // Toujours commencer au mois actuel
            renderCalendarGrid();
            updateCalendarNavButtons(); // D√©sactiver le bouton suivant au d√©marrage
            document.getElementById('calendarModal').classList.add('active');
        }

        function closeCalendarModal() {
            document.getElementById('calendarModal').classList.remove('active');
        }

        function changeCalendarMonth(delta) {
            const now = new Date();
            const newMonth = new Date(currentCalendarMonth);
            newMonth.setMonth(newMonth.getMonth() + delta);

            // Emp√™cher de naviguer vers les mois futurs
            if (delta > 0) {
                if (newMonth.getFullYear() > now.getFullYear() ||
                    (newMonth.getFullYear() === now.getFullYear() && newMonth.getMonth() > now.getMonth())) {
                    return; // Ne pas avancer au-del√† du mois actuel
                }
            }

            currentCalendarMonth = newMonth;
            renderCalendarGrid();
            updateCalendarNavButtons();
        }

        // Met √† jour l'√©tat des boutons de navigation
        function updateCalendarNavButtons() {
            const now = new Date();
            const nextBtn = document.querySelector('.calendar-header .calendar-nav-btn:last-child');

            if (nextBtn) {
                // D√©sactiver le bouton "suivant" si on est au mois actuel
                const isCurrentMonth = currentCalendarMonth.getFullYear() === now.getFullYear() &&
                    currentCalendarMonth.getMonth() === now.getMonth();
                nextBtn.disabled = isCurrentMonth;
                nextBtn.style.opacity = isCurrentMonth ? '0.3' : '1';
                nextBtn.style.cursor = isCurrentMonth ? 'not-allowed' : 'pointer';
            }
        }

        function renderCalendarGrid() {
            const container = document.getElementById('calendarGridContainer');
            const summaryContainer = document.getElementById('calendarSummary');
            const titleEl = document.getElementById('calendarTitle');

            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();

            // Mettre √† jour le titre
            const monthNames = ['JANVIER', 'F√âVRIER', 'MARS', 'AVRIL', 'MAI', 'JUIN',
                'JUILLET', 'AO√õT', 'SEPTEMBRE', 'OCTOBRE', 'NOVEMBRE', 'D√âCEMBRE'];
            titleEl.textContent = `üìÖ ${monthNames[month]} ${year}`;

            // R√©cup√©rer les donn√©es
            const data = getData();

            // Utiliser la variable globale habits (pas data.habits)
            // Si habits est vide, utiliser les habitudes par d√©faut
            const habitsToShow = (typeof habits !== 'undefined' && habits.length > 0) ? habits : [
                { id: 'coldshower', name: 'DOUCHE FROIDE', icon: 'üßä' },
                { id: 'reading', name: 'LECTURE (30 min)', icon: 'üìö' },
                { id: 'nutrition', name: 'NUTRITION CLEAN', icon: 'ü•ó' },
                { id: 'sleep', name: 'SOMMEIL 8H+', icon: 'üò¥' },
                { id: 'hydration', name: 'HYDRATATION 2L+', icon: 'üíß' },
                { id: 'wakeup', name: 'R√âVEIL 5H-6H', icon: '‚è∞' }
            ];

            // Utiliser les vraies donn√©es (pas de g√©n√©ration automatique)
            let calendarData = data;

            if (habitsToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--accent-dark); padding: 20px;">Aucune habitude cr√©√©e</p>';
                summaryContainer.innerHTML = '';
                return;
            }

            // Calculer les jours du mois
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = (firstDay.getDay() + 6) % 7; // Lundi = 0
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let totalSuccess = 0;
            let totalFail = 0;
            let totalPossible = 0;

            // G√©n√©rer le HTML pour chaque habitude
            let html = '';

            habitsToShow.forEach((habit, habitIndex) => {
                let habitSuccess = 0;
                let habitFail = 0;
                let habitTotal = 0;

                // G√©n√©rer les jours pour cette habitude
                let daysHtml = '';

                // Headers des jours de la semaine
                const dayHeaders = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
                dayHeaders.forEach(d => {
                    daysHtml += `<div class="calendar-day-header">${d}</div>`;
                });

                // Cases vides avant le premier jour
                for (let i = 0; i < startDayOfWeek; i++) {
                    daysHtml += '<div class="calendar-day empty"></div>';
                }

                // Jours du mois
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    date.setHours(0, 0, 0, 0);
                    const dateKey = getDateKey(date);

                    const dayData = calendarData.days && calendarData.days[dateKey];
                    const isCompleted = dayData && dayData[habit.id] === true;
                    const isPast = date < today;
                    const isToday = date.getTime() === today.getTime();
                    const isFuture = date > today;

                    let dayClass = 'calendar-day';
                    const animDelay = (day * 0.02) + (habitIndex * 0.1);

                    if (isFuture) {
                        dayClass += ' future';
                    } else if (isCompleted) {
                        dayClass += ' success';
                        habitSuccess++;
                        totalSuccess++;
                    } else if (isPast) {
                        dayClass += ' fail';
                        habitFail++;
                        totalFail++;
                    }

                    if (isToday) {
                        dayClass += ' today';
                    }

                    if (!isFuture) {
                        habitTotal++;
                        totalPossible++;
                    }

                    daysHtml += `<div class="${dayClass}" style="animation-delay: ${animDelay}s">${day}</div>`;
                }

                // Calculer le pourcentage
                const percent = habitTotal > 0 ? Math.round((habitSuccess / habitTotal) * 100) : 0;
                let percentClass = 'bad';
                if (percent >= 80) percentClass = 'good';
                else if (percent >= 50) percentClass = 'medium';

                html += `
                    <div class="calendar-habit-section">
                        <div class="calendar-habit-header">
                            <span class="calendar-habit-icon">${habit.icon}</span>
                            <span class="calendar-habit-name">${habit.name}</span>
                            <span class="calendar-habit-percent ${percentClass}">${percent}%</span>
                        </div>
                        <div class="calendar-days-grid">
                            ${daysHtml}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // R√©sum√© du mois
            const overallPercent = totalPossible > 0 ? Math.round((totalSuccess / totalPossible) * 100) : 0;

            let motivationMessage = '';
            let motivationClass = '';

            if (overallPercent >= 80) {
                motivationMessage = 'üèÜ Exceptionnel ! Tu domines ce mois avec une discipline de fer !';
            } else if (overallPercent >= 60) {
                motivationMessage = 'üí™ Bon travail ! Continue sur cette lanc√©e !';
            } else if (overallPercent >= 40) {
                motivationMessage = '‚ö° Tu peux faire mieux. Chaque jour est une nouvelle opportunit√© !';
                motivationClass = 'warning';
            } else {
                motivationMessage = 'üî• C\'est l\'heure de se battre ! Reprends le contr√¥le de tes habitudes !';
                motivationClass = 'warning';
            }

            summaryContainer.innerHTML = `
                <div class="summary-title">R√©sum√© du mois</div>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <span class="summary-stat-value green">${totalSuccess}</span>
                        <span class="summary-stat-label">R√©ussites</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-value red">${totalFail}</span>
                        <span class="summary-stat-label">√âchecs</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-value blue">${overallPercent}%</span>
                        <span class="summary-stat-label">Global</span>
                    </div>
                </div>
                <div class="calendar-motivation ${motivationClass}">${motivationMessage}</div>
            `;
        }
    </script>
</body>

</html>